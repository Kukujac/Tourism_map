<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tourism Map of Ghana with Road Routing & Interactive Tutorial</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Required stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lightbox for image zoom -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">

    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            overflow: hidden;
            background-color: #f8f9fa;
        }

        #storymap {
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
        }

        .storymap-story {
            height: 100vh;
            overflow-y: auto;
            background-color: #fff;
            padding: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
            -webkit-overflow-scrolling: touch;
        }

        .storymap-map {
            height: 100vh;
            padding: 0;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .fullscreen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
            padding: 20px;
            text-align: center;
            background-size: cover;
            background-position: center;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('img/Akwaaba.jpg');
        }

        /* Custom background for the end section */
        .fullscreen.end-section {
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('img/finish.jpg');
        }

        .scene-content {
            padding: 20px 0;
            display: none;
            border-bottom: 1px solid #eee;
        }

        .scene-content.active {
            display: block !important;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .img-thumbnail {
            margin: 12px 0;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .img-thumbnail:hover {
            transform: scale(1.02);
        }

        /* Mobile-first responsive controls */
        .map-controls {
            position: absolute;
            top: 50px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 180px;
        }

        .basemap-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .basemap-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .basemap-btn:hover {
            background: #e9ecef;
        }

        .basemap-btn.active:hover {
            background: #2980b9;
        }

        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: calc(100vw - 200px);
            max-width: 280px;
        }

        .search-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-results {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
            display: none;
            -webkit-overflow-scrolling: touch;
        }

        .search-result-item {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        /* Custom marker styles - ALL CIRCULAR */
        .custom-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.4);
            background-size: cover;
            background-position: center;
            border: 3px solid white;
            border-radius: 50% !important;
            transition: all 0.5s ease;
        }

        /* Focused marker with glow effect */
        .custom-marker.focused {
            box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.8);
            transform: scale(1.2);
            z-index: 1000;
            animation: glow 2s infinite alternate;
        }

        /* Dimmed marker style */
        .custom-marker.dimmed {
            opacity: 0.4;
            filter: grayscale(70%);
            transform: scale(0.8);
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px 5px rgba(255, 215, 0, 0.6);
            }
            to {
                box-shadow: 0 0 25px 12px rgba(255, 215, 0, 0.9);
            }
        }

        .leaflet-popup-content {
            max-width: 280px;
            font-size: 14px;
        }

        .custom-popup img {
            width: 100%;
            height: auto;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .legend {
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            line-height: 1.4;
            font-size: 12px;
        }

        .legend h4 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--dark-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 50%;
        }

        .scene-nav {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .scene-nav button {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 14px;
        }

        .scene-indicator {
            position: absolute;
            top: 20px;
            left: 330px;
            z-index: 1000;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-weight: bold;
            color: var(--dark-color);
            font-size: 14px;
            max-width: calc(100vw - 200px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e9ecef;
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 0 4px 4px 0;
        }

        h2 {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 1.5rem;
        }

        h1.display-4 {
            font-weight: 700;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 2rem;
        }

        p {
            text-align: justify;
            line-height: 1.6;
            color: #555;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .site-list {
            position: absolute;
            top: 50px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-height: 250px;
            overflow-y: auto;
            width: calc(100vw - 200px);
            max-width: 280px;
            display: none;
            -webkit-overflow-scrolling: touch;
        }

        .site-list h5 {
            margin-top: 0;
            margin-bottom: 8px;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
            font-size: 14px;
        }

        .site-item {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .site-item:hover {
            background: #f8f9fa;
            padding-left: 8px;
        }

        .site-item.active {
            background: var(--primary-color);
            color: white;
            padding-left: 8px;
        }

        .site-type-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .mobile-menu-btn {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
        }

        .site-counter {
            position: absolute;
            bottom: 20px;
            right: 300px;
            z-index: 1000;
            background: white;
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-weight: bold;
            color: var(--dark-color);
            font-size: 12px;
        }

        .reference {
            font-size: 0.8em;
            color: #777;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-size: 14px;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        /* Rotation Controls */
        .rotation-controls {
            position: absolute;
            bottom: 400px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 150px;
        }

        .rotation-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .rotation-btn:hover {
            background: #e9ecef;
        }

        .rotation-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Cluster Controls */
        .cluster-controls {
            position: absolute;
            top: 220px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 150px;
        }

        .cluster-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .cluster-btn:hover {
            background: #e9ecef;
        }

        .cluster-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Image Gallery Styles */
        .image-gallery {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }

        .gallery-item {
            border-radius: 6px;
            overflow: hidden;
            height: 80px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1002;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-align: center;
            font-size: 14px;
        }

        /* Combined Routing Controls */
        .combined-routing-controls {
            position: absolute;
            bottom: 400px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: calc(100vw - 200px);
            max-width: 280px;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .combined-routing-controls h6 {
            margin: 0 0 8px 0;
            color: var(--dark-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 4px;
            font-size: 13px;
        }

        .combined-routing-btn {
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
        }

        .combined-routing-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .combined-routing-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .combined-routing-btn.success {
            background: #28a745;
            color: white;
        }

        .combined-routing-btn.warning {
            background: #ffc107;
            color: #212529;
        }

        .combined-routing-btn.danger {
            background: #dc3545;
            color: white;
        }

        .combined-routing-section {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .combined-routing-section h7 {
            font-size: 11px;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 6px;
            display: block;
        }

        .routing-status {
            font-size: 10px;
            padding: 5px 6px;
            border-radius: 4px;
            margin-top: 6px;
            background: #e9ecef;
            border-left: 3px solid #6c757d;
        }

        .routing-status.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .routing-status.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .routing-status.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        .waypoint-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            margin-top: 4px;
            padding: 3px 6px;
            background: #e3f2fd;
            border-radius: 4px;
            color: var(--primary-color);
        }

        /* Route Summary in Sidebar */
        .route-summary-sidebar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 15px 0;
            display: none;
        }

        .route-summary-sidebar h3 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 1.3rem;
        }

        .route-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }

        .route-waypoints {
            margin-top: 15px;
        }

        .waypoint-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .waypoint-item {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .waypoint-item:last-child {
            border-bottom: none;
        }

        .waypoint-number {
            background: var(--primary-color);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
            font-size: 0.8em;
        }

        .waypoint-details {
            flex: 1;
        }

        .waypoint-name {
            font-weight: bold;
            color: var(--dark-color);
            font-size: 13px;
        }

        .waypoint-coords {
            font-size: 0.7em;
            color: #666;
            font-family: monospace;
        }

        .route-segments {
            margin-top: 15px;
        }

        .segment-item {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .segment-item:last-child {
            border-bottom: none;
        }

        /* Enhanced Segment Direction Styles */
        .segment-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .direction-arrow {
            margin: 0 6px;
            color: var(--primary-color);
            font-weight: bold;
        }

        .segment-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 11px;
        }

        .segment-direction {
            background: #e3f2fd;
            color: var(--primary-color);
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            border: 1px solid #bbdefb;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .segment-direction .fas {
            font-size: 0.8em;
        }

        .segment-distance {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 12px;
        }

        .segment-time {
            color: #666;
            font-size: 11px;
        }

        .road-info {
            font-size: 0.7em;
            color: #666;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .road-direction {
            margin-top: 4px;
            padding: 6px;
            background: #e3f2fd;
            border-radius: 6px;
            font-size: 11px;
            color: #1976d2;
            border-left: 3px solid #2196f3;
        }

        /* Unit Toggle Styles */
        .unit-toggle {
            margin-bottom: 12px;
        }

        .unit-toggle .btn-group {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .unit-toggle .btn {
            font-size: 11px;
            padding: 5px 6px;
        }

        .unit-toggle .btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Custom Location Modal */
        .custom-location-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .custom-location-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .location-input-group {
            margin-bottom: 12px;
        }

        .location-input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .location-input-group input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .location-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Current Location Marker */
        .current-location-marker {
            background-color: #4285F4;
            border: 3px solid white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Toggle Controls Button */
        .toggle-controls-btn {
            position: absolute;
            bottom: 300px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 12px;
        }

        /* Map Click Mode Indicator */
        .map-click-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            pointer-events: none;
            font-size: 14px;
            text-align: center;
            max-width: 90%;
        }

        /* Measurement Controls */
        .measurement-controls {
            position: absolute;
            bottom: 100px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: calc(100vw - 200px);
            max-width: 180px;
        }

        .measurement-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .measurement-btn:hover {
            background: #e9ecef;
        }

        .measurement-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .measurement-results {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 11px;
            display: none;
        }

        .measurement-unit-toggle {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .unit-btn {
            flex: 1;
            padding: 3px 6px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }

        .unit-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* TUTORIAL SYSTEM STYLES */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
        }

        .tutorial-popup {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            z-index: 3001;
            animation: tutorialSlideIn 0.5s ease-out;
        }

        @keyframes tutorialSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .tutorial-header {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-title {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0;
        }

        .tutorial-step {
            background: var(--primary-color);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
        }

        .tutorial-content {
            padding: 20px;
            line-height: 1.5;
            font-size: 14px;
        }

        .tutorial-feature-highlight {
            background: #e3f2fd;
            border-left: 4px solid var(--primary-color);
            padding: 10px 12px;
            margin: 12px 0;
            border-radius: 4px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 13px;
        }

        .tutorial-buttons {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-top: 1px solid #eee;
            gap: 8px;
        }

        .tutorial-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            font-size: 14px;
        }

        .tutorial-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .tutorial-btn-secondary {
            background: #f8f9fa;
            color: var(--dark-color);
            border: 1px solid #ddd;
        }

        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tutorial-progress {
            height: 4px;
            background: #e9ecef;
            margin: 0 15px;
            border-radius: 2px;
            overflow: hidden;
        }

        .tutorial-progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .feature-highlight {
            position: absolute;
            border: 3px solid #ffeb3b;
            background: rgba(255, 235, 59, 0.1);
            border-radius: 8px;
            z-index: 2999;
            animation: pulseHighlight 2s infinite;
            box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7);
        }

        @keyframes pulseHighlight {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 235, 59, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 235, 59, 0);
            }
        }

        .tutorial-start-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            white-space: nowrap;
        }

        .tutorial-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .tutorial-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: none;
        }

        /* ==================== */
        /* RESPONSIVE DESIGN */
        /* ==================== */

        /* Mobile devices (portrait) */
        @media (max-width: 575.98px) {
            .storymap-story {
                position: fixed;
                width: 100%;
                height: 45vh;
                bottom: 0;
                z-index: 1000;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                padding: 10px;
            }

            .storymap-story.active {
                transform: translateY(0);
            }

            .storymap-map {
                height: 55vh;
            }

            .mobile-menu-btn {
                display: block;
            }

            .scene-indicator {
                left: 50px;
                top: 50px;
                max-width: calc(100vw - 120px);
                font-size: 12px;
            }

            .search-container {
                width: calc(100vw - 120px);
                left: 50px;
                top: 50px;
            }

            .map-controls {
                top: 50px;
                right: 10px;
                max-width: 150px;
            }

            .rotation-controls {
                bottom: 100px;
                max-width: 130px;
            }

            .cluster-controls {
                bottom: 150px;
                max-width: 130px;
            }

            .combined-routing-controls {
                bottom: 200px;
                width: calc(100vw - 120px);
                max-width: 250px;
            }

            .measurement-controls {
                bottom: 50px;
                width: calc(100vw - 120px);
                max-width: 160px;
            }

            .toggle-controls-btn {
                bottom: 250px;
            }

            .route-stats {
                grid-template-columns: 1fr;
            }

            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .gallery-item {
                height: 70px;
            }

            .scene-nav {
                bottom: 10px;
                left: 10px;
            }

            .scene-nav button {
                padding: 6px 12px;
                font-size: 12px;
            }

            .site-counter {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
            }

            h2 {
                font-size: 1.3rem;
            }

            h1.display-4 {
                font-size: 1.8rem;
            }

            p {
                font-size: 13px;
            }

            .tutorial-start-btn {
                right: 10px;
                top: 50px;
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .tutorial-indicator {
                right: 10px;
                top: 50px;
                font-size: 0.7em;
            }
        }

        /* Small devices (landscape phones, 576px and up) */
        @media (min-width: 576px) and (max-width: 767.98px) {
            .storymap-story {
                position: fixed;
                width: 100%;
                height: 50vh;
                bottom: 0;
                z-index: 1000;
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }

            .storymap-story.active {
                transform: translateY(0);
            }

            .storymap-map {
                height: 50vh;
            }

            .mobile-menu-btn {
                display: block;
            }

            .scene-indicator {
                left: 60px;
                top: 60px;
            }

            .search-container {
                width: calc(100vw - 140px);
                left: 60px;
            }

            .combined-routing-controls {
                width: calc(100vw - 140px);
            }

            .measurement-controls {
                width: calc(100vw - 140px);
            }
        }

        /* Medium devices (tablets, 768px and up) */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .storymap-story {
                height: 100vh;
            }

            .combined-routing-controls {
                width: 250px;
            }

            .measurement-controls {
                width: 200px;
            }
        }

        /* Large devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .storymap-story {
                height: 100vh;
            }

            .combined-routing-controls {
                width: 220px;
            }

            .measurement-controls {
                width: 200px;
            }
        }

        /* Extra large devices (large desktops, 1200px and up) */
        @media (min-width: 1200px) {
            .storymap-story {
                height: 100vh;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .custom-marker {
                border-width: 2px;
            }
            
            .img-thumbnail {
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .basemap-btn:hover,
            .rotation-btn:hover,
            .cluster-btn:hover,
            .combined-routing-btn:hover,
            .measurement-btn:hover {
                background: #f8f9fa;
                transform: none;
            }

            .basemap-btn.active:hover,
            .rotation-btn.active:hover,
            .cluster-btn.active:hover,
            .combined-routing-btn.active:hover,
            .measurement-btn.active:hover {
                background: var(--primary-color);
            }

            .img-thumbnail:hover {
                transform: none;
            }

            .gallery-item:hover {
                transform: none;
            }

            /* Increase touch target sizes */
            .basemap-btn,
            .rotation-btn,
            .cluster-btn,
            .combined-routing-btn,
            .measurement-btn,
            .search-result-item,
            .site-item {
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .scene-nav button {
                min-height: 44px;
                min-width: 80px;
            }

            .mobile-menu-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .toggle-controls-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .storymap-story {
                background-color: #1a1a1a;
                color: #ffffff;
            }

            .map-controls,
            .rotation-controls,
            .cluster-controls,
            .combined-routing-controls,
            .measurement-controls,
            .search-container,
            .site-list,
            .scene-indicator,
            .site-counter,
            .legend {
                background: #2d2d2d;
                color: #ffffff;
            }

            .basemap-btn,
            .rotation-btn,
            .cluster-btn,
            .combined-routing-btn,
            .measurement-btn {
                background: #3d3d3d;
                color: #ffffff;
            }

            .basemap-btn:hover,
            .rotation-btn:hover,
            .cluster-btn:hover,
            .combined-routing-btn:hover,
            .measurement-btn:hover {
                background: #4d4d4d;
            }

            .search-input {
                background: #2d2d2d;
                color: #ffffff;
                border-color: #555;
            }

            p {
                color: #cccccc;
            }

            h2 {
                color: #ffffff;
            }
        }
    </style>
</head>
<body>

<!-- Tutorial Start Button -->
<button class="tutorial-start-btn" id="start-tutorial">
    <i class="fas fa-play-circle"></i> Interactive Tutorial
</button>

<div class="tutorial-indicator" id="tutorial-indicator">
    <i class="fas fa-graduation-cap"></i> Tutorial Active
</div>

<!-- Tutorial Overlay System -->
<div class="tutorial-overlay" id="tutorial-overlay"></div>

<div id="storymap" class="container-fluid">
    <div class="row no-gutters">
        <div class="col-md-5 col-lg-4 storymap-story">
            <button class="mobile-menu-btn" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>

            <section data-scene="overview" class="fullscreen active">
                <div class="text-center">
                    <h1 class="display-4">TOURIST SITES IN GHANA</h1>
                    <h3 style="color: #FFD700">EXPLORE THE RICH CULTURE AND HISTORY</h3>
                    <p class="mt-4" style="color: white;">Scroll through to discover amazing tourist destinations across Ghana</p>
                    <button class="btn btn-primary btn-lg mt-4" id="start-tour">
                        <i class="fas fa-play-circle mr-2"></i>Start Tour
                    </button>
                </div>
            </section>

            <!-- Route Summary Section in Sidebar -->
            <section class="route-summary-sidebar" id="route-summary-sidebar">
                <h3><i class="fas fa-route mr-2"></i>Route Summary</h3>

                <!-- Unit Toggle Buttons -->
                <div class="unit-toggle mb-3">
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="use-km">
                            <i class="fas fa-ruler-combined mr-1"></i>KM/M
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="use-miles">
                            <i class="fas fa-ruler mr-1"></i>Miles
                        </button>
                    </div>
                </div>

                <div class="offline-route-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Road Network Routing</strong> - Using Ghana road data
                </div>

                <div class="route-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-distance">0 km</div>
                        <div class="stat-label">Total Distance</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-time">0 min</div>
                        <div class="stat-label">Estimated Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="waypoint-count">0</div>
                        <div class="stat-label">Waypoints</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="segment-count">0</div>
                        <div class="stat-label">Segments</div>
                    </div>
                </div>

                <div class="route-waypoints">
                    <h5><i class="fas fa-map-marker-alt mr-2"></i>Waypoints</h5>
                    <div class="waypoint-list" id="waypoint-list">
                        <!-- Waypoints will be populated here -->
                    </div>
                </div>

                <div class="route-segments">
                    <h5><i class="fas fa-road mr-2"></i>Route Segments</h5>
                    <div id="segment-list">
                        <!-- Route segments will be populated here -->
                    </div>
                </div>

                <button class="btn btn-primary btn-block mt-3" id="clear-route-sidebar">
                    <i class="fas fa-trash mr-2"></i>Clear Route
                </button>
            </section>
            
            <section data-scene="christian" class="scene-content">
                <h2>CHRISTIANBORG CASTLE</h2>
                <a href="img/christian.png" data-lightbox="christian" data-title="Christiansborg Castle">
                    <img src="img/christian.png" class="img-responsive img-thumbnail" alt="Christiansborg Castle">
                </a>
                <p><b>Osu Castle, also known as Fort Christiansborg or simply the Castle, is a castle located in Osu, Accra, Ghana on the coast of the Atlantic Ocean's Gulf of Guinea. The first substantial fort was built by Denmark-Norway in the 1660s, though the castle has changed hands between Denmark-Norway, Portugal, the Akwamu, Britain, and finally post-Independence Ghana, and was rebuilt numerous times. At this site, the Danes built a stone fort in 1659, to replace the earthen lodge that had been erected by the Swedish African Company in the 17th century. They named it Christiansborg, meaning 'Christian's Fortress', after the King of Denmark, Christian IV, who passed away in 1648.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/christian_2.jpg" data-lightbox="christian-gallery" data-title="View of Christiansborg Castle">
                        <div class="gallery-item">
                            <img src="img/gallery/christian_2.jpg" alt="View of Christiansborg Castle">
                        </div>
                    </a>                        
                    <a href="img/gallery/christian_0.jpg" data-lightbox="christian-gallery" data-title="View of Christiansborg Castle">
                        <div class="gallery-item">
                            <img src="img/gallery/christian_0.jpg" alt="View of Christiansborg Castle">
                        </div>
                    </a>
                        <a href="img/gallery/christian_1.jpg" data-lightbox="christian-gallery" data-title="View of Christiansborg Castle">
                        <div class="gallery-item">
                            <img src="img/gallery/christian_1.jpg" alt="View of Christiansborg Castle">
                        </div>
                    </a>
                </div>

                <p><b>Escalating Danish trade, initially in gold, then in slaves, necessitated further expansions of the castle such that finally the castle almost quadrupled its original size. The abolition of the slave trade by Denmark in 1803 resulted in a severe trade slump. The castle was sold to the British in 1850.</b></p>
                <p><b>After 1876, British colonial governors ruled from the castle. They abandoned it from 1890 to 1901, when it was used as a constabulary mess, and later as a psychiatric asylum. In 1902, Christiansburg Castle once again became the seat of government which houses the offices of the President of Ghana until it was moved to Golden Jubilee House after 6 January 2009.</b></p>

                <div class="reference">
                    <p><b>References:</b> http://www.ghanamuseums.org/forts/fort-christianburg.php
                    Anquandah, Kwesi J., Castles and Forts of Ghana, 1999, page 31</p>
                </div>
            </section>

            <section data-scene="conference" class="scene-content">
                <h2>ACCRA CONFERENCE CENTRE</h2>
                <a href="img/conference.png" data-lightbox="conference" data-title="Accra Conference Centre">
                    <img src="img/conference.png" class="img-responsive img-thumbnail" alt="Accra Conference Centre">
                </a>
                <p><b>The Accra International Conference Center is perhaps the most popular venue in Accra which often plays host to most important international gatherings and has ready access to Kotoka Airport and first-class hotels, the multi-purpose conference center has a 6,000-person capacity. It is a center of attention for everyone doing business in West Africa. Other venues include the Ghana Trade Fair and the National Theatre, but the Conference Center is more popular due to it being significantly larger than the National Theatre, and at the same time smaller than the Ghana Trade Fair Centre (which was built to host pan-African events).</b></p>
                
                <div class="image-gallery">
                    <a href="img/gallery/conference_4.jpg" data-lightbox="conference-gallery" data-title="View of Accra Conference Centre">
                        <div class="gallery-item">
                            <img src="img/gallery/conference_4.jpg" alt="View of Accra Conference Centre">
                        </div>
                    </a>                        
                    <a href="img/gallery/conference_2.webp" data-lightbox="conference-gallery" data-title="View of Accra Conference Centre">
                        <div class="gallery-item">
                            <img src="img/gallery/conference_2.webp" alt="View of Accra Conference Centre">
                        </div>
                    </a>
                        <a href="img/gallery/conference_1.jpg" data-lightbox="conference-gallery" data-title="View of Accra Conference Centre">
                        <div class="gallery-item">
                            <img src="img/gallery/conference_1.jpg" alt="View of Accra Conference Centre ">
                        </div>
                    </a>
                </div>

                <p><b>It is located in the Christiansborg area in Osu, Accra and is close to a number of important locations, such as the Parliament of Ghana, the Accra Sports Stadium, the Independence Arch and the Black Star Square. It was built in 1991 to host the Tenth Ministerial Meeting of the Non-Aligned Movement. It has since hosted major conferences and summits by U.N. organisations, such as the World Health Organisation, the Food and Agriculture Organisation, as well as regional organisations such as ECOWAS.</b></p>

                <div class="reference">
                    <p><b>References:</b> https://www.ghana.travel/tourism-directory/hotels/accra-international-conference-centre/</p>
                </div>
            </section>

            <section data-scene="theatre" class="scene-content">
                <h2>THE NATIONAL THEATRE</h2>
                <a href="img/theatre.png" data-lightbox="theatre" data-title="The National Theatre">
                    <img src="img/theatre.png" class="img-responsive img-thumbnail" alt="The National Theatre">
                </a>
                <p><b>The construction of the National Theatre commenced on 8th March 1990, completed on 16th December 1992, commissioned and handed over on 30th December 1992 to spearhead the Theatre movement in Ghana by providing a multi-functional venue for concerts, dance, drama and musical performances, screen plays, exhibitions and special events. In Ghana, theatre as an artistic form has existed for centuries in the traditional dramatic expressions of society, however, the National Theatre Movement (NTM) was conceived around the time of Ghana's independence in 1957 to help remold the new nation's cultural identity.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/theatre_1.jpg" data-lightbox="theatre-gallery" data-title="View of The National Theatre">
                        <div class="gallery-item">
                            <img src="img/gallery/theatre_1.jpg" alt="View of The National Theatre">
                        </div>
                    </a>                        
                    <a href="img/gallery/theatre_2.jpg" data-lightbox="theatre-gallery" data-title="View of The National Theatre">
                        <div class="gallery-item">
                            <img src="img/gallery/theatre_2.jpg" alt="View of The National Theatre">
                        </div>
                    </a>
                        <a href="img/gallery/theatre_3.webp" data-lightbox="theatre-gallery" data-title="View of The National Theatre">
                        <div class="gallery-item">
                            <img src="img/gallery/theatre_3.webp" alt="View of The National Theatre">
                        </div>
                    </a>
                </div>

                <p><b>The building is for people of all ages and walks of life. The Theatre, a building with a complex structure, has a total building area of 11,896 square metres and houses the three resident companies of the National Dance Company, the National Symphony Orchestra, and the National Theatre Players.</b></p>

                <div class="reference">
                    <p><b>References:</b> Lokko, Sophia (September 1980). "Theatre Space: A Historical Overview of the Theatre Movement in Ghana". Modern Drama. 23 (3): 310. doi:10.3138/md.23.3.309. ISSN 0026-7694. National Theatre of Ghana. ghana-net.com
                    http://www.nationaltheatre.gov.gh/history/</p>
                </div>
            </section>

            <section data-scene="mausoleum" class="scene-content">
                <h2>KWAME NKRUMAH MAUSOLEUM</h2>
                <a href="img/mausoleum.png" data-lightbox="mausoleum" data-title="Kwame Nkrumah Mausoleum">
                    <img src="img/mausoleum.png" class="img-responsive img-thumbnail" alt="Kwame Nkrumah Mausoleum">
                </a>
                <p><b>Built on the former British Polo Grounds and located in downtown Accra, the Kwame Nkrumah Mausoleum and memorial park was designed by Don Arthur and dedicated in 1992 to the first President of the Republic of Ghana, Osagyefo Dr. Kame Nkrumah, who led the campaign towards independence from British colonial rule.</b></p>
                <p><b>It was the point where Nkrumah declared independence in March 6, 1957 and is now the final resting place of Kwame Nkrumah and his wife Fathia Nkrumah. The park consists of about 5.3 acres of land. The memorial complex holds key artefacts of his life story and serves as the location that marked the transition of the name Gold Coast to Ghana.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/mausoleum_5.jpg" data-lightbox="mausoleum-gallery" data-title="View of Kwame Nkrumah Mausoleum">
                        <div class="gallery-item">
                            <img src="img/gallery/mausoleum_5.jpg" alt="View of Kwame Nkrumah Mausoleum">
                        </div>
                    </a>                        
                    <a href="img/gallery/mausoleum_3.jpg" data-lightbox="mausoleum-gallery" data-title="View of Kwame Nkrumah Mausoleum">
                        <div class="gallery-item">
                            <img src="img/gallery/mausoleum_3.jpg" alt="View of Kwame Nkrumah Mausoleum">
                        </div>
                    </a>
                        <a href="img/gallery/mausoleum_1.jpg" data-lightbox="mausoleum-gallery" data-title="View of Kwame Nkrumah Mausoleum">
                        <div class="gallery-item">
                            <img src="img/gallery/mausoleum_1.jpg" alt="View of Kwame Nkrumah Mausoleum">
                        </div>
                    </a>
                </div>

                <p><b>The building is meant to represent an upside-down sword, which in Akan culture is a symbol of peace, others also view it as an uprooted tree, signifying the unfinished works of Nkrumah. The mausoleum is clad from top to bottom with Italian marble, with a black star at its apex to symbolize unity. The interior boasts marble flooring and a mini mastaba looking marble grave marker, surrounded by river-washed rocks. A skylight at the top in the mausoleum illuminates the grave. It is surrounded by water, as symbol of life.</b></p>

                <div class="reference">
                    <p><b>References:</b> https://www.graphic.com.gh/features/features/re-living-accra-old-polo-grounds-now-nkrumah-mausoleum.html, Jul 11 , 2013. By: Arku Jasmine. Retrieved 28-01-2020
                    https://en.wikipedia.org/wiki/Kwame_Nkrumah_Mausoleum
                    https://www.kempinski.com/en/accra/hotel-gold-coast-city/meetings/incentives/kwame-nkrumah-mausoleum/</p>
                </div>
            </section>

            <section data-scene="museumtech" class="scene-content">
                <h2>MUSEUM OF SCIENCE AND TECHNOLOGY</h2>
                <a href="img/museumtech.png" data-lightbox="museumtech" data-title="Museum of Science and Technology">
                    <img src="img/museumtech.png" class="img-responsive img-thumbnail" alt="Museum of Science and Technology">
                </a>
                <p><b>The Museum of Science and Technology in Accra was established when two lecturers from the Legon Campus of the University of Ghana, identified a need to create awareness of past and current developments in science and technology in Ghana, and presented a proposal for the development of the institution to Kwame Nkrumah, the then president of Ghana. A short time later, in 1965, the Museum of Science and Technology opened its doors. The institution endeavors to inspire those who visit, particularly its more youthful guests, with a desire to discover more about the sciences and technological development in the world around them.</b></p>
                <p><b>Exhibits include a human heart and a piece of stone from the moon. The museum incorporates a library, and provides educational activities for children.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/museumtech_1.webp" data-lightbox="museumtech-gallery" data-title="View of Museum of Science and Technology">
                        <div class="gallery-item">
                            <img src="img/gallery/museumtech_1.webp" alt="View of Museum of Science and Technology">
                        </div>
                    </a>                        
                    <a href="img/gallery/museumtech_3.jpg" data-lightbox="museumtech-gallery" data-title="View of Museum of Science and Technology">
                        <div class="gallery-item">
                            <img src="img/gallery/museumtech_3.jpg" alt="View of Museum of Science and Technology">
                        </div>
                    </a>
                        <a href="img/gallery/museumtech_2.jpg" data-lightbox="museumtech-gallery" data-title="View of Museum of Science and Technology">
                        <div class="gallery-item">
                            <img src="img/gallery/museumtech_2.jpg" alt="View of Museum of Science and Technology">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> http://www.ghanamuseums.org/science-tech-museum.php</p>
                </div>
            </section>

            <section data-scene="nordsee" class="scene-content">
                <h2>NORDSEE BEACH RESORT</h2>
                <a href="img/nordsee.png" data-lightbox="nordsee" data-title="Nordsee Beach Resort">
                    <img src="img/nordsee.png" class="img-responsive img-thumbnail" alt="Nordsee Beach Resort">
                </a>
                <p><b>This resort has an international hotel conveniently located in Accra on the Atlantic Coast of West Africa. Here, guests and tourists alike are presented the unique opportunity to savor Ghanaian tradition and hospitality without compromising state-of-the-art conveniences. Their friendly and dedicated team ensures you have a pleasant and wonderful stay to relax in a tropical setting.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/nordsee_1.webp" data-lightbox="nordsee-gallery" data-title="View of Nordsee Beach Resort">
                        <div class="gallery-item">
                            <img src="img/gallery/nordsee_1.webp" alt="View of Nordsee Beach Resort">
                        </div>
                    </a>                        
                    <a href="img/gallery/nordsee_3.jpg.jpg" data-lightbox="nordsee-gallery" data-title="View of Nordsee Beach Resort">
                        <div class="gallery-item">
                            <img src="img/gallery/nordsee_3.jpg.jpg" alt="View of Nordsee Beach Resort">
                        </div>
                    </a>
                        <a href="img/gallery/nordsee_2.jpg" data-lightbox="nordsee-gallery" data-title="View of Nordsee Beach Resort">
                        <div class="gallery-item">
                            <img src="img/gallery/nordsee_2.jpg" alt="View of Nordsee Beach Resort">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> https://www.tripadvisor.com/Hotel_Review-g293797-d6741987-Reviews-Nordsee_Beach_Resort-Accra_Greater_Accra.html</p>
                </div>
            </section>

            <section data-scene="james" class="scene-content">
                <h2>FORT JAMES</h2>
                <a href="img/james.png" data-lightbox="james" data-title="Fort James">
                    <img src="img/james.png" class="img-responsive img-thumbnail" alt="Fort James">
                </a>
                <p><b>Fort James is located The fort is located in Jamestown, Accra, Ghana. It was built by the British as a trading post in 1673, where it joined the Dutch Fort Crêvecœur (1649), and the Danish Fort Christiansborg (1652).</b></p>
                <p><b>Fort James derived its name from a town known as Jamestown in Accra. The fort stands next to Jamestown Lighthouse and from colonial times up to the year 2008 the fort served the Ghanaian society as a prison. It is an historic castle and serves as a tourist site, however, it is in moderately good condition.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/james_2.jpg" data-lightbox="james-gallery" data-title="View of Fort James">
                        <div class="gallery-item">
                            <img src="img/gallery/james_2.jpg" alt="View of Fort James">
                        </div>
                    </a>                        
                    <a href="img/gallery/james_3.jpg" data-lightbox="james-gallery" data-title="View of Fort James">
                        <div class="gallery-item">
                            <img src="img/gallery/james_3.jpg" alt="View of Fort James">
                        </div>
                    </a>
                        <a href="img/gallery/james_3.webp" data-lightbox="james-gallery" data-title="View of Fort James">
                        <div class="gallery-item">
                            <img src="img/gallery/james_3.webp" alt="View of Fort James">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> "Ghana Museums & Monuments Board". www.ghanamuseums.org.
                    Briggs, Philip. Ghana (Sixth ed.). Bradt Travel Guides Ltd. p. 147. ISBN 9781841624785.
                    Centre, UNESCO World Heritage. "Forts and Castles, Volta, Greater Accra, Central and Western Regions". whc.unesco.org.
                    https://en.wikipedia.org/wiki/Fort_James_(Ghana)</p>
                </div>
            </section>

            <section data-scene="square" class="scene-content">
                <h2>BLACK STAR SQUARE</h2>
                <a href="img/square.png" data-lightbox="square" data-title="Black Star Square">
                    <img src="img/square.png" class="img-responsive img-thumbnail" alt="Black Star Square">
                </a>
                <p><b>Black Star Square, also known as Independence Square, is a vast public square of concrete overlooked by spectator stands of Stalinesque grace located in Accra, Ghana, bordered by the Accra Sports Stadium and the Kwame Nkrumah Memorial Park. The square often hosts the annual independence celebrations as well as other national events. It is currently the site for all civic and military parades in Ghana. It was completed in the year 1961 and Kwame Nkrumah commissioned the square to celebrate his nation's newfound autonomy, however, it coincided with the visit of Queen Elizabeth II.</b></p>
                
                <div class="image-gallery">
                    <a href="img/gallery/square_3.jpg" data-lightbox="square-gallery" data-title="View of Black Star Square">
                        <div class="gallery-item">
                            <img src="img/gallery/square_3.jpg" alt="View of Black Star Square">
                        </div>
                    </a>                        
                    <a href="img/gallery/square_2.jpg" data-lightbox="square-gallery" data-title="View of Black Star Square">
                        <div class="gallery-item">
                            <img src="img/gallery/square_2.jpg" alt="View of Black Star Square">
                        </div>
                    </a>
                        <a href="img/gallery/square_4.jpg" data-lightbox="square-gallery" data-title="View of Black Star Square">
                        <div class="gallery-item">
                            <img src="img/gallery/square_4.jpg" alt="View of Black Star Square">
                        </div>
                    </a>
                </div>
                
                <p><b>In Independence Square are stands that can seat 30,000 people. On March 24th 1998, over 500,000 people gathered at the square to welcome former U.S. President Bill Clinton and his wife, Hillary Clinton. This event marked the first U.S. president to visit Ghana. The square boasts of some monuments. These monuments include the Independence Arch to the south of the square beneath which the Eternal Flame of African Liberation, lit by Kwame Nkrumah, still flickers. It stands empty for most of the year, except for special commemorations, backdropped by the Gulf of Guinea. On the opposite side of the square but facing the arch is the Memorial of the Unknown Soldier, which honors the Ghanaian soldiers who fell fighting for their country. Just to the north of the main square is a roundabout, in the center of which stands the Black Star Gate, an imposing monument topped by the Black Star of Africa, the five-pointed star that symbolizes Africa in general and Ghana in particular. The monument bears the large inscription "AD 1957" and "Freedom and Justice."</b></p>

                <div class="reference">
                    <p><b>References:</b> "Black Star Square". Atlas Obscura. Retrieved 28-01-2020
                    GOCKING, ROGER S. (2005). The History of Ghana. ABC-CLIO. ISBN 1282417908. OCLC 732281154. Retrieved 28-01-2020
                    https://en.wikipedia.org/wiki/Black_Star_Square</p>
                </div>
            </section>

            <section data-scene="artcent" class="scene-content">
                <h2>CENTRE FOR NATIONAL CULTURE</h2>
                <a href="img/artcent.png" data-lightbox="artcent" data-title="Centre for National Culture">
                    <img src="img/artcent.png" class="img-responsive img-thumbnail" alt="Centre for National Culture">
                </a>
                <p><b>The Accra regional center for culture, "The Arts Center", is better known simply as the National Center for Culture in the central business district of Accra, Ghana. It comprises of a large air-conditioned theatre hall where local dance groups and actors perform and numerous stalls exhibit and sell traditional arts and crafts bazaars and a traditional textile market with souvenirs that have been crafted in clay, wood, leather and metal. There is also indoor market with stalls having footwear, tee shirts and other souvenirs.</b></p>
                
                <div class="image-gallery">
                    <a href="img/gallery/artcent_1.jpeg" data-lightbox="artcent-gallery" data-title="View of Centre for National Culture ">
                        <div class="gallery-item">
                            <img src="img/gallery/artcent_1.jpeg" alt="View of Centre for National Culture">
                        </div>
                    </a>                        
                    <a href="img/gallery/artcent_2.jpeg" data-lightbox="artcent-gallery" data-title="View of Centre for National Culture">
                        <div class="gallery-item">
                            <img src="img/gallery/artcent_2.jpeg" alt="View of Centre for National Culture">
                        </div>
                    </a>
                        <a href="img/gallery/artcent_3.jpeg" data-lightbox="artcent-gallery" data-title="View of Centre for National Culture">
                        <div class="gallery-item">
                            <img src="img/gallery/artcent_3.jpeg" alt="View of Centre for National Culture">
                        </div>
                    </a>
                </div>
                
                <p><b>It is situated right next to the Kwame Nkrumah Memorial Park. The Centre was set up to promote and preserve Ghanaian culture and heritage. Moreover, the Arts Center offers a variety of goods in different designs, motifs and colors in one location. From kente items, wood carvings, beads, leather boxes, drums, baskets, fans, local leather bags and many more.</b></p>

                <div class="reference">
                    <p><b>References:</b> http://amedzofevillage.com/en/2016/05/10/center-for-national-culture-art-center/
                    https://visitghana.com/shopping_location/centre-for-national-culture/</p>
                </div>
            </section>

            <section data-scene="mina" class="scene-content">
                <h2>ELMINA CASTLE</h2>
                <a href="img/mina.png" data-lightbox="mina" data-title="Elmina Castle">
                    <img src="img/mina.png" class="img-responsive img-thumbnail" alt="Elmina Castle">
                </a>
                <p><b>Elmina and Elmina Castle was the first trading post built on the Gulf of Guinea, so is the oldest European building in existence below the Sahara.</b></p>
                <p><b>First established as a trade settlement, the castle later became one of the most important stops on the route of the Atlantic slave trade. The Dutch seized the fort from the Portuguese in 1637, and took over all the Portuguese Gold Coast in 1642.</b></p>
                <p><b>The slave trade continued under the Dutch until 1814. In 1872 the Dutch Gold Coast, including the fort, became a possession of the British Empire. The Gold Coast, which is now Ghana, gained its independence in 1957 from Britain, and had control of the castle. Elmina Castle is a historical site, and was a major filming location for Werner Herzog's 1987 drama film Cobra Verde. The castle is recognized by UNESCO as a World Heritage Site.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/mina_1.jpg" data-lightbox="mina-gallery" data-title="View of ELMINA CASTLE ">
                        <div class="gallery-item">
                            <img src="img/gallery/mina_1.jpg" alt="View of ELMINA CASTLE">
                        </div>
                    </a>                        
                    <a href="img/gallery/mina_3.jpg" data-lightbox="mina-gallery" data-title="View of ELMINA CASTLE">
                        <div class="gallery-item">
                            <img src="img/gallery/mina_3.jpg" alt="View of ELMINA CASTLE">
                        </div>
                    </a>
                        <a href="img/gallery/mina_4.jpg" data-lightbox="mina-gallery" data-title="View of ELMINA CASTLE">
                        <div class="gallery-item">
                            <img src="img/gallery/mina_4.jpg" alt="View of ELMINA CASTLE">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> http://elminacastle.info/index.html
                    https://en.wikipedia.org/wiki/Elmina_Castle</p>
                </div>
            </section>

            <section data-scene="mccarthy" class="scene-content">
                <h2>FORT MCCARTHY</h2>
                <a href="img/mccarthy.png" data-lightbox="mccarthy" data-title="Fort McCarthy">
                    <img src="img/mccarthy.png" class="img-responsive img-thumbnail" alt="Fort McCarthy">
                </a>
                <p><b>Fort McCarthy is located in Cape Coast, of the Central Region of Ghana. It was built by the British as trading post, in 1822. The fort is in ruin with little remains.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/mccarthy_1.jpg" data-lightbox="mccarthy-gallery" data-title="View of Fort McCarthy ">
                        <div class="gallery-item">
                            <img src="img/gallery/mccarthy_1.jpg" alt="View of Fort McCarthy">
                        </div>
                    </a>                        
                        <a href="img/gallery/mccarthy_2.jpg" data-lightbox="mccarthy-gallery" data-title="View of Fort McCarthy">
                        <div class="gallery-item">
                            <img src="img/gallery/mccarthy_2.jpg" alt="View of Fort McCarthy">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> http://www.ghanamuseums.org/forts/fort-mccarthy.php
                    http://ghana-net.com/fort-mccarthy-cape-coast.html</p>
                </div>
            </section>

            <section data-scene="jago" class="scene-content">
                <h2>FORT SAINT JAGO</h2>
                <a href="img/jago.png" data-lightbox="jago" data-title="Fort Saint Jago">
                    <img src="img/jago.png" class="img-responsive img-thumbnail" alt="Fort Saint Jago">
                </a>
                <p><b>A small Portuguese chapel dedicated to Saint Jago, had previously stood where (also known as Fort Coenraadsburg) now sits on a high hill opposite St. George's Castle (Elmina Castle), in the Central Region of Ghana. This fort is a good illustration of a people learning from their history. In 1637, the Dutch installed heavy guns on the hill from where they had barraged the weakest side of Portuguese-controlled St. George's Castle, forcing its surrender.</b></p>
                <p><b>To protect St. George's Castle from attack via similar tactics, the Dutch, by the 1660s, had constructed a permanent fort, which was considered 'the oldest and purely military architecture of the Gold Coast'. Built for purely military reasons, that is, the defence and protection of St. George's Castle, the fort had only military quarters and no commercial warehouses. Its strongest bastions are trained inland, from where an attack would have most likely emanated.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/jago_1.jpg" data-lightbox="jago-gallery" data-title="View of Fort Saint Jago ">
                        <div class="gallery-item">
                            <img src="img/gallery/jago_1.jpg" alt="View of Fort Saint Jago">
                        </div>
                    </a>                        
                    <a href="img/gallery/jago_3.jpg" data-lightbox="jago-gallery" data-title="View of Fort Saint Jago">
                        <div class="gallery-item">
                            <img src="img/gallery/jago_3.jpg" alt="View of Fort Saint Jago">
                        </div>
                    </a>
                        <a href="img/gallery/jago_4.jpg" data-lightbox="jago-gallery" data-title="View of Fort Saint Jago">
                        <div class="gallery-item">
                            <img src="img/gallery/jago_4.jpg" alt="View of Fort Saint Jago">
                        </div>
                    </a>
                </div>

                <p><b>In 1503, according to historical narration by the Portuguese Diego de Alvarenga, a Portuguese missionary converted and baptized the paramount chief of the Efutu Kingdom on the Mina coast together with 300 of his subjects. The chief permitted the Portuguese to build a church on the hill located opposite the Castle St. Jorge. The site was dedicated to the Portuguese saint, Jago. In 1637, the Dutch employed the hill as a gun-position to bombard and take Elmina Castle from the Portuguese. The following year, the Dutch, seeking to protect the castle from the landward side, built on St. Jago hill, 33 meters above sea level, a redoubt or fortified quadrilateral earthwork with a tower and gate and a single-storied building within a courtyard all surrounded by an embankment. In the 1660's, the Dutch used local sandstone rock to build a permanent fort to replace the earthen fortification, which was then destroyed. The stone fort, named Coenraadsburg, is unique and impressive as oldest purely military architecture of the Gold Coast".</b></p>

                <div class="reference">
                    <p><b>References:</b> https://ghana.peacefmonline.com/pages/tourism/castles_forts/fort_st_jago/
                    http://www.ghanamuseums.org/forts/fort-st-jago.php</p>
                </div>
            </section>

            <section data-scene="points" class="scene-content">
                <h2>CAPE THREE POINTS</h2>
                <a href="img/points.png" data-lightbox="points" data-title="Cape Three Points">
                    <img src="img/points.png" class="img-responsive img-thumbnail" alt="Cape Three Points">
                </a>
                <p><b>The village of Cape Three Points is a small peninsula and a southernmost community in the Western Region of Ghana on the Atlantic Ocean, and its beach is one of the most beautiful along Ghana's West Coast. It comprises of a large Deepwater block located offshore with several oil and gas discoveries. It is also Surrounded by Ghana's only coastal rainforest reserve and many rolling hills, hiking, beach and sea activities.</b></p>
                <p><b>Cape Three Points is best known for its lighthouses, the first of which was constructed in 1875 by the British as a navigational aid for trading vessels sailing through the Gulf of Guinea. Although the original structure is in a dilapidated state, an improved lighthouse was completed in 1921, and is still functioning today.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/points_1.png" data-lightbox="anthony-gallery" data-title="View of Cape Three Points ">
                        <div class="gallery-item">
                            <img src="img/gallery/points_1.png" alt="View of Cape Three Points">
                        </div>
                    </a>                        
                    <a href="img/gallery/points_2.jpg" data-lightbox="anthony-gallery" data-title="View of Cape Three Points">
                        <div class="gallery-item">
                            <img src="img/gallery/points_2.jpg" alt="View of Cape Three Points">
                        </div>
                    </a>
                        <a href="img/gallery/points_3.png" data-lightbox="anthony-gallery" data-title="View of Cape Three Points">
                        <div class="gallery-item">
                            <img src="img/gallery/points_3.png" alt="View of Cape Three Points">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> Cape Three Points Ghana. Touringghana.com, Cape Three Points. Ghanawestcoast.com, Limits of Oceans and Seas, 3rd edition" (PDF). International Hydrographic Organization. 1953. Retrieved 7 February 2010</p>
                </div>
            </section>

            <section data-scene="dorothea" class="scene-content">
                <h2>FORT DOROTHEA</h2>
                <a href="img/dorothea.png" data-lightbox="dorothea" data-title="Fort Dorothea">
                    <img src="img/dorothea.png" class="img-responsive img-thumbnail" alt="Fort Dorothea">
                </a>
                <p><b>In 1685, the Brandenburg African company (German: Brandenburgisch-Afrikanische Compagnie (de) built a lodge in Akwida, a small town and fishing village in Ahanta West district. According to Albert van Danzig, Fort Dorothea was originally built as a small triangular building. From the top of the Dorothea's rounded rocky hill, you will enjoy stunning views of the surrounding area.</b></p>
                <p><b>The fort was temporarily in Dutch hands in 1687-98. Given back to Brandenburgers, in 1698. Abandoned about 1709. In the hands of the Dutch, in 1712. Relinquished to the Brandenburgers in 1712. Sold to the Dutch, in 1718.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/dorothea_1.jpg" data-lightbox="anthony-gallery" data-title="View of Fort Dorothea ">
                        <div class="gallery-item">
                            <img src="img/gallery/dorothea_1.jpg" alt="View of Fort Dorothea">
                        </div>
                    </a>                       
                </div>

                <div class="reference">
                    <p><b>References:</b> fort-dorothea/www.ghanamuseums.org, Van Dantzig, Albert, Forts and Castles of Ghana, pg 45.</p>
                </div>
            </section>

            <section data-scene="dixcove" class="scene-content">
                <h2>FORT METAL CROSS</h2>
                <a href="img/dixcove.png" data-lightbox="dixcove" data-title="Fort Metal Cross">
                    <img src="img/dixcove.png" class="img-responsive img-thumbnail" alt="Fort Metal Cross">
                </a>
                <p><b>The British colonial fortification, Fort Metal Cross (originally Dixcove Fort) is a military structure located on a promontory near the fishing village of Infuma, in Dixcove (Dick's Cove) in the Western Region of Ghana. The cove's quiet waters are suitable for small boats and canoes; large ships anchor approximately 2 kilometres offshore.</b></p>
                <p><b>Work commenced in 1683, but progress was impaired by continuous disputes between the English and the Brandenburgers. Building completed by the English, in 1691-97. Besieged, in 1748-56 and abandoned, in 1826. Re-occupied in 1830. Transferred to the Dutch and renamed Metalen Kruis, in 1868 under the Anglo-Dutch Gold Coast Treaty . Ceded to British, on 6th April, 1872 as per the Gold Coast treaty of 1871, and they renamed it Fort Metal Cross. Restored in 1954-56. Like Fort Batentstein, Fort Metal Cross became a service-station for the repair of ships and the supply of timber from the surrounding forest; and during the slave trade, it became a slave prison.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/dixcove_1.jpg" data-lightbox="anthony-gallery" data-title="View of Fort Metal Cross ">
                        <div class="gallery-item">
                            <img src="img/gallery/dixcove_1.jpg" alt="View of Fort Metal Cross">
                        </div>
                    </a>                        
                    <a href="img/gallery/dixcove_2.jpg" data-lightbox="anthony-gallery" data-title="View of Fort Metal Cross">
                        <div class="gallery-item">
                            <img src="img/gallery/dixcove_2.jpg" alt="View of Fort Metal Cross">
                        </div>
                    </a>
                        <a href="img/gallery/dixcove_3.jpg" data-lightbox="anthony-gallery" data-title="View of Fort Metal Cross">
                        <div class="gallery-item">
                            <img src="img/gallery/dixcove_3.jpg" alt="View of Fort Metal Cross">
                        </div>
                    </a>
                </div>


                <div class="reference">
                    <p><b>References:</b> Van Dantzig, Albert, Forts and Castles of Ghana, pg 45
                    Doortmont, Michel René; Smit, Jinna (2007). Sources for the Mutual History of Ghana and the Netherlands: An Annotated Guide to the Dutch Archives Relating to Ghana and West Africa in the Nationaal Archief, 1593-1960s (in Dutch). BRILL. p. 325. ISBN 9004158502.
                    Briggs, Philip; Connolly, Sean (2016-12-05). Ghana. Bradt Travel Guides. p. 247. ISBN 9781784770341.</p>
                </div>
            </section>

            <section data-scene="busua" class="scene-content">
                <h2>BUSUA BEACH</h2>
                <a href="img/busua.png" data-lightbox="busua" data-title="Busua Beach">
                    <img src="img/busua.png" class="img-responsive img-thumbnail" alt="Busua Beach">
                </a>
                <p><b>Busua is a beach resort and fishing village in the Ahanta West District of the Western Region in Ghana, about 30 kilometers west of the regional capital, Sekondi-Takoradi in the Gulf of Guinea. Busua fishing village is known for blue marlin and tuna fishery. Since the late 1990s, the town has not only obtained full electricity connection, but also restaurants and several lodges and bungalows and luxury real estate. From Busua can be reached on foot in about 25 minutes to the west the fishing village of Dixcove, the old original British stronghold Fort Metal Cross and to the east of the small town, the former Dutch fortress Fort Batenstein (in English, Fort Baten stone) can both be visited.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/busua_1.jpg" data-lightbox="busua-gallery" data-title="View of Busua Beach">
                        <div class="gallery-item">
                            <img src="img/gallery/busua_1.jpg" alt="View of Busua Beach">
                        </div>
                    </a>                        
                    <a href="img/gallery/busua_2.jpg" data-lightbox="busua-gallery" data-title="View of Busua Beach">
                        <div class="gallery-item">
                            <img src="img/gallery/busua_2.jpeg" alt="View of Busua Beach">
                        </div>
                    </a>
                        <a href="img/gallery/busua_3.jpg" data-lightbox="busua-gallery" data-title="View of Busua Beach">
                        <div class="gallery-item">
                            <img src="img/gallery/busua_3.jpeg" alt="View of Busua Beach">
                        </div>
                    </a>
                </div>

                <p><b>Busua has until the 1960s been a town with a tradition as a being an seaside resort for wealthy locals from Sekondi-Takoradi. In the 1970s and 1980s, there were also a number of European tourists who visit Busua, although there was until the late 1990s, neither electricity nor running water. A small bungalow resort was the only tourist infrastructure, electricity in the town was occasionally available in the weekends by a generator.</b></p>

                <div class="reference">
                    <p><b>References:</b> Will Bendix (2014-11-27). "Ghana: A slice of surfing adventure off the beaten track". Timeslive.co.za. Retrieved 2020-01-24. https://independent-travellers.com/ghana/busua/67.php. Retrieved 2020-01-24. https://en.wikipedia.org/wiki/Busua. Van Dantzig, Albert, Forts and Castles of Ghana, pg 45</p>
                </div>
            </section>

            <section data-scene="batenstein" class="scene-content">
                <h2>FORT BATENSTEIN</h2>
                <a href="img/batenstein.png" data-lightbox="batenstein" data-title="Fort Batenstein">
                    <img src="img/batenstein.png" class="img-responsive img-thumbnail" alt="Fort Batenstein">
                </a>
                <p><b>Fort Batenstein is situated on the high hill behind Butre village in the Western Region of Ghana, the view of the Atlantic coastline from the bastions of Fort Batenstein is quite sensational. Like Dixcove and Fredericksburg, it was among the early historic settlements generated by the 17th century inter-European and inter-African conflicts, partly because it lay close to the gold-rich hinterland. It was the promise of gold in the hinterland, and not simply the beauty of this ecological paradise, that prompted the Dutch to construct this small trading fort in 1656.</b></p>
                <p><b>Batenstein literally translates to "profit fort". Taken by the English, in 1665, abandoned in 1818-27, rebuilt by the Dutch, in 1828, relinquished by treaty and remained a Dutch possession until 1872, when it was ceded with the entire Dutch Gold Coast to the British. However, amidst the verdant vegetation, clean air and the waters of the beach, life at Fort Batenstein must have been and still is, idyllic. The fort is currently preserved as a ruin. Butre has a Town Tourism Development Committee, which offers guided tours to Fort Batenstein and the local area.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/batenstein_1.jpg" data-lightbox="batenstein-gallery" data-title="Side View of Fort Batenstein">
                        <div class="gallery-item">
                            <img src="img/gallery/batenstein_1.jpg" alt="Side View of Batenstein">
                        </div>
                    </a>                        
                    <a href="img/gallery/batenstein_2.jpg" data-lightbox="batenstein-gallery" data-title="Exit of Fort Batenstein">
                        <div class="gallery-item">
                            <img src="img/gallery/batenstein_2.jpg" alt="Exit of Fort Batenstein">
                        </div>
                    </a>
                        <a href="img/gallery/batenstein_4.webp" data-lightbox="batenstein-gallery" data-title="Side View of Fort Batenstein">
                        <div class="gallery-item">
                            <img src="img/gallery/batenstein_4.webp" alt="Side View of Fort Batenstein">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> https://visitghana.com/attractions/fort-batenstein/, https://www.ghana.travel/places-to-visit/fort-batenstein/, https://en.wikipedia.org/wiki/Fort_Batenstein</p>
                </div>
            </section>

            <section data-scene="anthony" class="scene-content">
                <h2>FORT SAINT ANTHONY</h2>
                <a href="img/anthony.png" data-lightbox="anthony" data-title="Fort Saint Anthony">
                    <img src="img/anthony.png" class="img-responsive img-thumbnail" alt="Fort Saint Anthony">
                </a>
                <p><b>Fort St. Anthony was built in 1515, the second fort built by the Portuguese on the Gold Coast after Elmina Castle (St. George's Castle which was built between 1482 and 1486). It is a massive triangular fort on a small promontory closer to the River Ankobra, Axim in the Western Region of Ghana. The effective defensive capability of Fort St. Anthony was revealed by its ability to withstand attacks for over four years, even after the fall of Elmina to the Dutch in 1637. By the 1720s, St. Anthony had become a Dutch fort. The fort was ceded to Britain in 1872. The fort is now the property of the Ghanaian state and is open to the public.</b></p>


                <div class="image-gallery">
                    <a href="img/gallery/anthony_1.jpg" data-lightbox="anthony-gallery" data-title="Plan View of Fort Saint Anthony">
                        <div class="gallery-item">
                            <img src="img/gallery/anthony_1.jpg" alt="Plan View of Fort Saint Anthony">
                        </div>
                    </a>                        
                    <a href="img/gallery/anthony_2.jpg" data-lightbox="anthony-gallery" data-title="Exit of Fort Saint Anthony">
                        <div class="gallery-item">
                            <img src="img/gallery/anthony_2.jpg" alt="Exit of Fort Saint Anthony">
                        </div>
                    </a>
                        <a href="img/gallery/anthony_3.jpg" data-lightbox="anthony-gallery" data-title="Side View of Fort Saint Anthony">
                        <div class="gallery-item">
                            <img src="img/gallery/anthony_3.jpg" alt="Side View of Fort Saint Anthony">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> http://www.ghanamuseums.org/forts/fort-st-anthony.php
                    http://cannundrum.blogspot.com/2014/11/fort-st-anthony-axim-ghana.html retrieved 2020-01-24
                    Anquandah, Kwesi J., Castles and Forts of Ghana, 1999, page 94
                    https://www.zamaniproject.org/site-ghana-axim-fort-saint-anthony.html</p>
                </div>
            </section>

            <section data-scene="orange" class="scene-content">
                <h2>FORT ORANGE</h2>
                <a href="img/orange.png" data-lightbox="orange" data-title="Fort Orange">
                    <img src="img/orange.png" class="img-responsive img-thumbnail" alt="Fort Orange">
                </a>
                <p><b>Originally a Dutch fortress, Fort Orange is located a few metres off Sekondi's harbour, in the Western Region. Though it served as a trading post for some time, Fort Orange was originally intended to be as a lodge, and it served that purpose during the 1670s. It was joined by an English Fort Sekondi in 1682. The trading post was enlarged into a fort in 1690. However, the 1670s were also years of intense European competition for the wealth of the Gold Coast, and to weaken the Dutch stronghold on the coast, the English built a succession of forts and lodges within gunning range of Dutch fortresses. After this lodge was attacked by the indigenous people - for instance, when it was attacked by the Ahtantas in September 1694. It was reconstructed into a much more fortified fort by 1704.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/orange_1.jpg" data-lightbox="orange-gallery" data-title="Side View of Fort Orange">
                        <div class="gallery-item">
                            <img src="img/gallery/orange_1.jpg" alt="Side View of Fort Orange">
                        </div>
                    </a>                        
                    <a href="img/gallery/orange_2.webp" data-lightbox="orange-gallery" data-title="Exit of Fort Saint Anthony">
                        <div class="gallery-item">
                            <img src="img/gallery/orange_2.webp" alt="Exit of Fort Saint Anthony">
                        </div>
                    </a>
                        <a href="img/gallery/orange_3.jpg" data-lightbox="orange-gallery" data-title="Side View of Fort Saint Anthony">
                        <div class="gallery-item">
                            <img src="img/gallery/orange_3.jpg" alt="Side View of Fort Saint Anthony">
                        </div>
                    </a>
                </div>

                <p><b>Since its cessation to the British in 1872, 'Fort Oranje', as it was called by the Dutch, has been used as a lighthouse. Fort Orange is now a naval base for the Ghana Ports and Harbours Authority.</b></p>
                
                <div class="reference">
                    <p><b>References:</b> "Ghana Museums & Monuments Board". www.ghanamuseums.org. Retrieved 2020-01-24
                    "Fort Orange". Afro Tourism. 2015-07-21. Retrieved 2020-01-24</p>
                </div>
            </section>

            <section data-scene="nzulezu" class="scene-content">
                <h2>NZULEZU STILT VILLAGE</h2>
                <a href="img/nzulezu.png" data-lightbox="nzulezu" data-title="Nzulezu Stilt Village">
                    <img src="img/nzulezu.png" class="img-responsive img-thumbnail" alt="Nzulezu Stilt Village">
                </a>
                <p><b>Near the coast at the far western side of Ghana, near the border with Cote d'Ivoire, is a village that is unique in all of Ghana. Spectacular scenery of the 400-year old stilt propped water settlement of Nzulezu, is a unique village built on stilts in Lake Tadane, which is home to hundreds of people in the Western Region.</b></p>
                
                <div class="image-gallery">
                    <a href="img/gallery/nzulezu_1.jpg" data-lightbox="nzulezu-gallery" data-title="View of Nzulezu Stilt Village">
                        <div class="gallery-item">
                            <img src="img/gallery/nzulezu_1.jpg" alt="View of Nzulezu Stilt Village">
                        </div>
                    </a>                        
                    <a href="img/gallery/nzulezu_3.webp" data-lightbox="nzulezu-gallery" data-title="View of Nzulezu Stilt Village">
                        <div class="gallery-item">
                            <img src="img/gallery/nzulezu_3.webp" alt="View of Nzulezu Stilt Village">
                        </div>
                    </a>
                        <a href="img/gallery/nzulezu_2.jpg" data-lightbox="nzulezu-gallery" data-title="View of Nzulezu Stilt Village">
                        <div class="gallery-item">
                            <img src="img/gallery/nzulezu_2.jpg" alt="View of Nzulezu Stilt Village">
                        </div>
                    </a>
                </div>

                <p><b>Nzulezu is an Nzema word meaning 'surface of water'. The inhabitants of the village are said to have migrated from Walata, a city in the ancient Ghana Empire, the earliest of the Western Sudanese States. According to tradition, ancestors of the village were brought to their present place by a snail. The serene ambiance of the surrounding landscape, coupled with the general activities of life on stilts points to a dynamic relationship between man and nature. It is essentially one long pier, called Main Street by the locals, with buildings constructed on both sides. One side of the 'street' are living quarters while the other side of the street has business, the school, a community centre and other commercial ventures.</b></p>

                <div class="reference">
                    <p><b>References:</b> https://visitghana.com/attractions/nzulezu-stilt-village/</p>
                </div>
            </section>

            <section data-scene="sebastian" class="scene-content">
                <h2>FORT SAN SEBASTIAN</h2>
                <a href="img/sebastian.png" data-lightbox="sebastian" data-title="Fort San Sebastian">
                    <img src="img/sebastian.png" class="img-responsive img-thumbnail" alt="Fort San Sebastian">
                </a>
                <p><b>In an area known as Shama, on the coast of Ghana's Western Region, lies Ghana's third oldest fortification. Fort San Sebastian is a historical architectural delight, reflecting the distinctive styles and preferences of both its Portuguese and Dutch sculpturing. Fort San Sebastian was built by the Portuguese from 1520 to 1526. Its original purpose was to serve as a deterrent to English sailors interfering in Shama trade.</b></p>
                <p><b>Fort San Sebastian has been described as a small-scale copy of St. George's Castle, and the fort received a mention in Di Castaldi's Venetian map of 1564. However, when the Dutch took over the fort in 1638, San Sebastian was a ruin. Rehabilitated in 1957, the fort is presently used as a post office and magistrate's court. It also serves as offices for the Electoral Commission.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/sebastian_1.jpg" data-lightbox="sebastian-gallery" data-title="View of Fort San Sebastian">
                        <div class="gallery-item">
                            <img src="img/gallery/sebastian_1.jpg" alt="View of Fort San Sebastian">
                        </div>
                    </a>                        
                    <a href="img/gallery/sebastian_4.webp" data-lightbox="sebastian-gallery" data-title="View of Fort San Sebastian">
                        <div class="gallery-item">
                            <img src="img/gallery/sebastian_4.webp" alt="View of Fort San Sebastian">
                        </div>
                    </a>
                        <a href="img/gallery/sebastian_2.jpg" data-lightbox="sebastian-gallery" data-title="View of Fort San Sebastian">
                        <div class="gallery-item">
                            <img src="img/gallery/sebastian_2.jpg" alt="View of Fort San Sebastian">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> http://www.ghanamuseums.org/forts/fort-san-sebastian.php</p>
                </div>
            </section>

            <section data-scene="brenu" class="scene-content">
                <h2>BRENU BEACH</h2>
                <a href="img/brenu.png" data-lightbox="brenu" data-title="Brenu Beach">
                    <img src="img/brenu.png" class="img-responsive img-thumbnail" alt="Brenu Beach">
                </a>
                <p><b>Brenu Beach Lodge is located in Brenu Akyinim, near Elmina, Ghana, and about 20km from the Elmina Castle. Featuring an award winning restaurant, comfortable and clean ocean-view rooms, and a pristine and clean private beach area, it is the perfect place to get-away and unplug.</b></p>

                <div class="image-gallery">
                    <a href="img/gallery/brenu_1.jpg" data-lightbox="brenu-gallery" data-title="View of Brenu Beach">
                        <div class="gallery-item">
                            <img src="img/gallery/brenu_1.jpg" alt="View of Brenu Beach">
                        </div>
                    </a>                        
                    <a href="img/gallery/brenu_2.jpg" data-lightbox="brenu-gallery" data-title="View of Brenu Beach">
                        <div class="gallery-item">
                            <img src="img/gallery/brenu_2.jpg" alt="View of Brenu Beach">
                        </div>
                    </a>
                        <a href="img/gallery/brenu_3.jpg" data-lightbox="brenu-gallery" data-title="View of Brenu Beach">
                        <div class="gallery-item">
                            <img src="img/gallery/brenu_3.jpg" alt="View of Fort Brenu Beach">
                        </div>
                    </a>
                </div>

                <div class="reference">
                    <p><b>References:</b> http://www.brenubeach.com/</p>
                </div>
            </section>

            <section data-scene="end" class="fullscreen end-section">
                <div class="text-center">
                    <h1 class="display-4">Y3 DA WO ASE!!!</h1>
                    <h3 style="color: #FFD700">THANKS FOR VISITING.</h3>
                    <p class="mt-4" style="color:white">We hope you enjoyed your virtual tour of Ghana's amazing tourist sites!</p>
                    <button class="btn btn-primary btn-lg mt-4" id="restart-tour">
                        <i class="fas fa-redo mr-2"></i>Restart Tour
                    </button>
                </div>
            </section>
        </div>

        <!-- Map div -->
        <div class="col-md-7 col-lg-8 storymap-map">
            <div id="map"></div>

            <!-- Map Click Mode Indicator -->
            <div class="map-click-indicator" id="map-click-indicator">
                <i class="fas fa-mouse-pointer mr-2"></i>Click anywhere on map to add location
            </div>

            <!-- Loading indicator -->
            <div class="loading-indicator" id="loading-indicator">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Calculating route...</p>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="site-search" placeholder="Search tourist sites...">
                <div class="search-results" id="search-results"></div>
            </div>

            <div class="map-controls">
                <h6>Base Maps</h6>
                <button class="basemap-btn active" data-basemap="osm">OpenStreetMap</button>
                <button class="basemap-btn" data-basemap="satellite">Satellite</button>
                <button class="basemap-btn" data-basemap="terrain">Terrain</button>
            </div>

            <div class="rotation-controls">
                <h6>View Mode</h6>
                <button class="rotation-btn" id="auto-rotate-off">Auto fly</button>
                <button class="rotation-btn active" id="auto-rotate-on">Auto Rotate off</button>
            </div>

            <div class="cluster-controls">
                <h6>Marker Display</h6>
                <button class="cluster-btn active" id="cluster-on">Clustered View</button>
                <button class="cluster-btn" id="cluster-off">Individual View</button>
            </div>

            <!-- Combined Routing Controls -->
            <div class="combined-routing-controls" id="combined-routing-controls">
                <h6><i class="fas fa-route mr-2"></i>Road Routing</h6>

                <!-- Road Network Section -->
                <div class="combined-routing-section">
                    <h7><i class="fas fa-road mr-1"></i>Road Network</h7>
                    <button class="combined-routing-btn" id="load-roads">
                        <i class="fas fa-download"></i>
                        Load Road Data
                    </button>
                    <button class="combined-routing-btn" id="toggle-roads" disabled>
                        <i class="fas fa-eye"></i>
                        Show Roads
                    </button>
                </div>

                <!-- Route Planning Section -->
                <div class="combined-routing-section">
                    <h7><i class="fas fa-map-signs mr-1"></i>Route Planning</h7>
                    <button class="combined-routing-btn" id="start-route">
                        <i class="fas fa-play-circle"></i>
                        Start Route Planning
                    </button>
                    <button class="combined-routing-btn" id="use-current-location">
                        <i class="fas fa-location-arrow"></i>
                        Use My Location
                    </button>
                    <button class="combined-routing-btn" id="add-custom-location">
                        <i class="fas fa-map-marker-alt"></i>
                        Add Custom Location
                    </button>
                    <button class="combined-routing-btn" id="map-click-mode">
                        <i class="fas fa-mouse-pointer"></i>
                        Click Map to Add
                    </button>
                    <button class="combined-routing-btn danger" id="clear-route">
                        <i class="fas fa-trash"></i>
                        Clear Route
                    </button>

                    <!-- Waypoint Counter -->
                    <div class="waypoint-counter" id="waypoint-counter">
                        <span>Waypoints:</span>
                        <strong id="waypoint-count-display">0</strong>
                    </div>
                </div>

                <!-- Routing Status -->
                <div class="routing-status info" id="routing-status">
                    <i class="fas fa-info-circle mr-1"></i>
                    Load road data to enable offline routing
                </div>
            </div>

            <!-- Measurement Controls -->
            <div class="measurement-controls" id="measurement-controls">
                <h6>Measurement Tools</h6>
                <button class="measurement-btn" id="measure-distance">
                    <i class="fas fa-ruler"></i> Measure Distance
                </button>
                <button class="measurement-btn" id="measure-area">
                    <i class="fas fa-draw-polygon"></i> Measure Area
                </button>
                <button class="measurement-btn" id="clear-measurements">
                    <i class="fas fa-trash"></i> Clear Measurements
                </button>

                <div class="measurement-unit-toggle">
                    <button class="unit-btn active" data-unit="metric">Metric</button>
                    <button class="unit-btn" data-unit="imperial">Imperial</button>
                </div>

                <div class="measurement-results" id="measurement-results">
                    <div id="distance-result"></div>
                    <div id="area-result"></div>
                </div>
            </div>

            <!-- Toggle Controls Button -->
            <button class="toggle-controls-btn" id="toggle-controls" title="Toggle Controls">
                <i class="fas fa-chevron-right" id="toggle-icon"></i>
            </button>

            <div class="site-list" id="site-list">
                <h5>Tourist Sites</h5>
                <div id="site-list-container"></div>
            </div>

            <div class="scene-indicator">
                <span id="current-scene">Overview</span>
            </div>

            <div class="site-counter">
                <span id="site-counter">1/22 Sites</span>
            </div>

            <div class="scene-nav">
                <button class="btn btn-primary" id="prev-scene">
                    <i class="fas fa-chevron-left mr-2"></i>Previous
                </button>
                <button class="btn btn-primary" id="next-scene">
                    Next<i class="fas fa-chevron-right ml-2"></i>
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="tour-progress"></div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Location Modal -->
<div class="custom-location-modal" id="custom-location-modal">
    <div class="custom-location-content">
        <h5>Add Custom Location</h5>
        <div class="location-input-group">
            <label for="custom-lat">Latitude</label>
            <input type="text" id="custom-lat" placeholder="e.g., 5.546861">
        </div>
        <div class="location-input-group">
            <label for="custom-lng">Longitude</label>
            <input type="text" id="custom-lng" placeholder="e.g., -0.183303">
        </div>
        <div class="location-input-group">
            <label for="custom-name">Location Name (Optional)</label>
            <input type="text" id="custom-name" placeholder="e.g., My Starting Point">
        </div>
        <div class="location-buttons">
            <button class="combined-routing-btn" id="cancel-custom-location">Cancel</button>
            <button class="combined-routing-btn active" id="confirm-custom-location">Add to Route</button>
        </div>
    </div>
</div>

<!-- Required libraries -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/@ngageoint/geopackage@4.1.1/dist/geopackage.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    // =============================================================================
    // INTERACTIVE TUTORIAL SYSTEM
    // =============================================================================

    // Tutorial steps configuration
    const tutorialSteps = [
        {
            title: "Welcome to Ghana Tourism Map!",
            content: "This interactive tutorial will guide you through all the amazing features of this tourism map. Let's explore Ghana's rich cultural heritage together!",
            target: null,
            position: "center",
            action: null
        },
        {
            title: "Map Navigation Basics",
            content: "Use your mouse to pan around the map and scroll to zoom in/out. The left panel shows detailed information about each tourist site.",
            target: "#map",
            position: "top",
            action: function() {
                // Ensure map is in overview view
                goToScene('overview');
            }
        },
        {
            title: "Tourist Sites Overview",
            content: "These colorful markers represent different types of tourist sites across Ghana. Each color indicates a different category:",
            target: ".custom-marker",
            position: "top",
            action: function() {
                highlightFeature('.custom-marker');
                showLegend();
            },
            featureNote: "🔴 Historical 🟠 Cultural 🟢 Beach 💚 Natural"
        },
        {
            title: "Base Map Options",
            content: "Switch between different map views to suit your preferences. Satellite view shows real imagery, while Terrain shows elevation.",
            target: ".map-controls",
            position: "left",
            action: function() {
                highlightFeature('.map-controls');
            }
        },
        {
            title: "Auto-Rotation Feature",
            content: "Enable auto-rotation for an immersive 360° view around locations. Perfect for getting your bearings at new sites!",
            target: ".rotation-controls",
            position: "right",
            action: function() {
                highlightFeature('.rotation-controls');
            }
        },
        {
            title: "Marker Clustering",
            content: "Toggle between clustered and individual marker views. Clustering helps keep the map clean when zoomed out.",
            target: ".cluster-controls",
            position: "right",
            action: function() {
                highlightFeature('.cluster-controls');
            }
        },
        {
            title: "Road Routing System",
            content: "This is the most powerful feature! Plan complete routes across Ghana with our advanced road network routing.",
            target: ".combined-routing-controls",
            position: "left",
            action: function() {
                highlightFeature('.combined-routing-controls');
            }
        },
        {
            title: "Load Road Network",
            content: "First, load Ghana's road data to enable offline routing capabilities. This only needs to be done once.",
            target: "#load-roads",
            position: "left",
            action: function() {
                highlightFeature('#load-roads');
            }
        },
        {
            title: "Start Route Planning",
            content: "Click here to begin planning your route. You'll be able to add destinations and calculate optimal paths.",
            target: "#start-route",
            position: "left",
            action: function() {
                highlightFeature('#start-route');
                // Auto-click to demonstrate
                setTimeout(() => {
                    if (!routingMode) {
                        $('#start-route').click();
                    }
                }, 1000);
            }
        },
        {
            title: "Add Your Location",
            content: "Use GPS to add your current location as a starting point for your route planning.",
            target: "#use-current-location",
            position: "left",
            action: function() {
                highlightFeature('#use-current-location');
            }
        },
        {
            title: "Add Tourist Sites",
            content: "Simply click on any tourist site marker while in routing mode to add it to your itinerary.",
            target: ".custom-marker",
            position: "top",
            action: function() {
                highlightFeature('.custom-marker');
                // Show example by highlighting a specific site
                const exampleSite = touristSites[0];
                showBriefNotification(`Click on ${exampleSite.name} to add to route`, [exampleSite.lat, exampleSite.lng]);
            }
        },
        {
            title: "Route Calculation",
            content: "The system automatically calculates the optimal route as you add waypoints. Watch the magic happen!",
            target: "#routing-status",
            position: "left",
            action: function() {
                highlightFeature('#routing-status');
                updateRoutingStatus('Route will be calculated automatically when you add 2+ waypoints', 'info');
            }
        },
        {
            title: "Route Summary",
            content: "View detailed route information including distance, time, turn-by-turn directions, and waypoint list.",
            target: "#route-summary-sidebar",
            position: "right",
            action: function() {
                highlightFeature('#route-summary-sidebar');
                // Show route summary if we have a route
                if (routeWaypoints.length >= 2) {
                    $('#route-summary-sidebar').show();
                }
            }
        },
        {
            title: "Measurement Tools",
            content: "Use these tools to measure distances and areas directly on the map. Perfect for planning and research.",
            target: ".measurement-controls",
            position: "right",
            action: function() {
                highlightFeature('.measurement-controls');
            }
        },
        {
            title: "Search Functionality",
            content: "Quickly find any tourist site by name using the search box. Results appear instantly as you type.",
            target: ".search-container",
            position: "left",
            action: function() {
                highlightFeature('.search-container');
                // Show search example
                $('#site-search').focus();
            }
        },
        {
            title: "Site List Overview",
            content: "Click the scene indicator to view all sites in a convenient list. Filter by type and navigate easily.",
            target: ".scene-indicator",
            position: "left",
            action: function() {
                highlightFeature('.scene-indicator');
                $('#site-list').show();
            }
        },
        {
            title: "Mobile Experience",
            content: "The map is fully responsive! On mobile devices, the story panel slides up from the bottom for easy access.",
            target: ".mobile-menu-btn",
            position: "bottom",
            action: function() {
                if (window.innerWidth <= 768) {
                    highlightFeature('.mobile-menu-btn');
                }
            }
        },
        {
            title: "Tour Complete!",
            content: "You're now ready to explore Ghana's amazing tourist destinations! Use the Restart Tour button anytime to begin again.",
            target: "#restart-tour",
            position: "center",
            action: function() {
                highlightFeature('#restart-tour');
                // Reset to clean state
                clearRoute();
                goToScene('overview');
            }
        }
    ];

    // Tutorial state management
    let currentTutorialStep = 0;
    let isTutorialActive = false;
    let currentHighlight = null;

    // Initialize tutorial system
    function initializeTutorialSystem() {
        // Start tutorial button
        $('#start-tutorial').click(function() {
            startTutorial();
        });

        // Close tutorial when clicking overlay (but not the popup)
        $('#tutorial-overlay').click(function(e) {
            if (e.target === this) {
                skipTutorial();
            }
        });
    }

    // Start the tutorial
    function startTutorial() {
        isTutorialActive = true;
        currentTutorialStep = 0;
        $('#tutorial-overlay').show();
        $('#tutorial-indicator').show();
        showTutorialStep(0);
    }

    // Show specific tutorial step
    function showTutorialStep(stepIndex) {
        const step = tutorialSteps[stepIndex];
        if (!step) return;

        // Update progress
        currentTutorialStep = stepIndex;
        const progress = ((stepIndex + 1) / tutorialSteps.length) * 100;
        $('.tutorial-progress-bar').css('width', progress + '%');

        // Clear previous highlight
        clearHighlight();

        // Execute step action if defined
        if (step.action && typeof step.action === 'function') {
            step.action();
        }

        // Create tutorial popup
        createTutorialPopup(step);
    }

    // Create tutorial popup for a step
    function createTutorialPopup(step) {
        // Remove existing popup
        $('.tutorial-popup').remove();

        const popup = $('<div class="tutorial-popup"></div>');
        
        // Header with title and step indicator
        const header = $(`
            <div class="tutorial-header">
                <h3 class="tutorial-title">${step.title}</h3>
                <div class="tutorial-step">${currentTutorialStep + 1}/${tutorialSteps.length}</div>
            </div>
        `);
        
        // Content area
        const content = $('<div class="tutorial-content"></div>');
        content.append(`<p>${step.content}</p>`);
        
        if (step.featureNote) {
            content.append(`<div class="tutorial-feature-highlight">${step.featureNote}</div>`);
        }

        // Progress bar
        const progressBar = $(`
            <div class="tutorial-progress">
                <div class="tutorial-progress-bar"></div>
            </div>
        `);

        // Buttons
        const buttons = $('<div class="tutorial-buttons"></div>');
        
        if (currentTutorialStep > 0) {
            buttons.append('<button class="tutorial-btn tutorial-btn-secondary" id="tutorial-prev">Previous</button>');
        } else {
            buttons.append('<div></div>'); // Empty spacer
        }
        
        buttons.append('<button class="tutorial-btn tutorial-btn-secondary" id="tutorial-skip">Skip Tutorial</button>');
        
        if (currentTutorialStep < tutorialSteps.length - 1) {
            buttons.append('<button class="tutorial-btn tutorial-btn-primary" id="tutorial-next">Next</button>');
        } else {
            buttons.append('<button class="tutorial-btn tutorial-btn-primary" id="tutorial-finish">Finish Tutorial</button>');
        }

        // Assemble popup
        popup.append(header);
        popup.append(content);
        popup.append(progressBar);
        popup.append(buttons);
        
        // Add to overlay
        $('#tutorial-overlay').append(popup);

        // Position the popup
        positionTutorialPopup(step, popup);

        // Add event listeners
        $('#tutorial-prev').click(function() {
            showTutorialStep(currentTutorialStep - 1);
        });

        $('#tutorial-next').click(function() {
            showTutorialStep(currentTutorialStep + 1);
        });

        $('#tutorial-skip').click(function() {
            skipTutorial();
        });

        $('#tutorial-finish').click(function() {
            finishTutorial();
        });
    }

    // Position tutorial popup based on step configuration
    function positionTutorialPopup(step, popup) {
        const overlay = $('#tutorial-overlay');
        const popupWidth = popup.outerWidth();
        const popupHeight = popup.outerHeight();

        if (step.target && step.position) {
            const target = $(step.target);
            if (target.length) {
                const targetOffset = target.offset();
                const targetWidth = target.outerWidth();
                const targetHeight = target.outerHeight();

                let top, left;

                switch (step.position) {
                    case 'top':
                        top = targetOffset.top - popupHeight - 20;
                        left = targetOffset.left + (targetWidth - popupWidth) / 2;
                        break;
                    case 'bottom':
                        top = targetOffset.top + targetHeight + 20;
                        left = targetOffset.left + (targetWidth - popupWidth) / 2;
                        break;
                    case 'left':
                        top = targetOffset.top + (targetHeight - popupHeight) / 2;
                        left = targetOffset.left - popupWidth - 20;
                        break;
                    case 'right':
                        top = targetOffset.top + (targetHeight - popupHeight) / 2;
                        left = targetOffset.left + targetWidth + 20;
                        break;
                    default:
                        // Center positioning
                        top = (overlay.height() - popupHeight) / 2;
                        left = (overlay.width() - popupWidth) / 2;
                }

                // Ensure popup stays within viewport
                top = Math.max(20, Math.min(top, overlay.height() - popupHeight - 20));
                left = Math.max(20, Math.min(left, overlay.width() - popupWidth - 20));

                popup.css({
                    top: top + 'px',
                    left: left + 'px'
                });

                // Highlight the target element
                highlightFeature(step.target);
            }
        } else {
            // Center positioning for steps without specific targets
            popup.css({
                top: (overlay.height() - popupHeight) / 2 + 'px',
                left: (overlay.width() - popupWidth) / 2 + 'px'
            });
        }
    }

    // Highlight a feature element
    function highlightFeature(selector) {
        clearHighlight();
        
        const element = $(selector).first();
        if (element.length) {
            const offset = element.offset();
            const width = element.outerWidth();
            const height = element.outerHeight();

            currentHighlight = $('<div class="feature-highlight"></div>');
            currentHighlight.css({
                top: offset.top + 'px',
                left: offset.left + 'px',
                width: width + 'px',
                height: height + 'px'
            });

            $('body').append(currentHighlight);
        }
    }

    // Clear current highlight
    function clearHighlight() {
        if (currentHighlight) {
            currentHighlight.remove();
            currentHighlight = null;
        }
    }

    // Skip the tutorial
    function skipTutorial() {
        isTutorialActive = false;
        $('#tutorial-overlay').hide();
        $('#tutorial-indicator').hide();
        clearHighlight();
        $('.tutorial-popup').remove();
        
        // Reset to clean state
        clearRoute();
        goToScene('overview');
    }

    // Finish the tutorial
    function finishTutorial() {
        skipTutorial();
        
        // Show completion message
        showBriefNotification('Tutorial completed! Enjoy exploring Ghana!', map.getCenter());
        
        // Ensure we're in a good starting state
        goToScene('overview');
        if (routingMode) {
            toggleRoutingMode();
        }
    }

    // Show legend temporarily (for tutorial)
    function showLegend() {
        // Create a temporary legend highlight
        const legend = $('.legend');
        if (legend.length) {
            legend.css({
                'box-shadow': '0 0 20px rgba(255, 215, 0, 0.8)',
                'transition': 'box-shadow 0.5s ease'
            });
            
            setTimeout(() => {
                legend.css('box-shadow', '');
            }, 3000);
        }
    }

    // Initialize tutorial when document is ready
    $(document).ready(function() {
        initializeTutorialSystem();
        
        // Auto-start tutorial on first visit (optional)
        const hasSeenTutorial = localStorage.getItem('ghanaMapTutorialSeen');
        if (!hasSeenTutorial) {
            setTimeout(() => {
                if (confirm('Welcome to the Ghana Tourism Map! Would you like to take a quick interactive tour of all the features?')) {
                    startTutorial();
                }
                localStorage.setItem('ghanaMapTutorialSeen', 'true');
            }, 2000);
        }
    });

    // =============================================================================
    // YOUR EXISTING JAVASCRIPT CODE CONTINUES BELOW
    // =============================================================================

    // Define base maps
    var baseLayers = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        }),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
            maxZoom: 17
        })
    };

    // Define all tourist sites with coordinates
    var touristSites = [
        { name: "Christiansborg Castle", lat: 5.546861, lng: -0.183303, type: "historical", scene: "christian", iconFile: "christian.png" },
        { name: "Accra Conference Centre", lat: 5.554323, lng: -0.193225, type: "cultural", scene: "conference", iconFile: "conference.png" },
        { name: "National Theatre", lat: 5.553796, lng: -0.20059, type: "cultural", scene: "theatre", iconFile: "theatre.png" },
        { name: "Kwame Nkrumah Mausoleum", lat: 5.544658, lng: -0.202911, type: "historical", scene: "mausoleum", iconFile: "mausoleum.png" },
        { name: "Museum of Science and Technology", lat: 5.556732, lng: -0.206160, type: "cultural", scene: "museumtech", iconFile: "museumtech.png" },
        { name: "Nordsee Beach Resort", lat: 5.528969, lng: -0.227011, type: "beach", scene: "nordsee", iconFile: "nordsee.png" },
        { name: "Fort James", lat: 5.533643, lng: -0.211343, type: "historical", scene: "james", iconFile: "james.png" },
        { name: "Black Star Square", lat: 5.548003, lng: -0.192701, type: "cultural", scene: "square", iconFile: "square.png" },
        { name: "Centre for National Culture", lat: 5.545632, lng: -0.201486, type: "cultural", scene: "artcent", iconFile: "artcent.png" },
        { name: "Elmina Castle", lat: 5.08256, lng: -1.347915, type: "historical", scene: "mina", iconFile: "mina.png" },
        { name: "Fort McCarthy", lat: 5.105, lng: -1.247, type: "historical", scene: "mccarthy", iconFile: "mccarthy.png" },
        { name: "Fort Saint Jago", lat: 5.084636, lng: -1.350853, type: "historical", scene: "jago", iconFile: "jago.png" },
        { name: "Cape Three Points", lat: 4.744545, lng: -2.089237, type: "natural", scene: "points", iconFile: "points.png" },
        { name: "Fort Dorothea", lat: 4.868, lng: -2.241, type: "historical", scene: "dorothea", iconFile: "dorothea.png" },
        { name: "Fort Metal Cross", lat: 4.789975, lng: -1.950406, type: "historical", scene: "dixcove", iconFile: "dixcove.png" },
        { name: "Busua Beach", lat: 4.80902, lng: -1.93553, type: "beach", scene: "busua", iconFile: "busua.png" },
        { name: "Fort Batenstein", lat: 4.821492, lng: -1.921041, type: "historical", scene: "batenstein", iconFile: "batenstein.png" },
        { name: "Fort Saint Anthony", lat: 4.868036, lng: -2.244521, type: "historical", scene: "anthony", iconFile: "anthony.png" },
        { name: "Fort Orange", lat: 4.935641, lng: -1.707309, type: "historical", scene: "orange", iconFile: "orange.png" },
        { name: "Nzulezu Stilt Village", lat: 5.020437, lng: -2.597027, type: "cultural", scene: "nzulezu", iconFile: "nzulezu.png" },
        { name: "Fort San Sebastian", lat: 5.019781, lng: -1.625831, type: "historical", scene: "sebastian", iconFile: "sebastian.png" },
        { name: "Brenu Beach", lat: 5.068054, lng: -1.422372, type: "beach", scene: "brenu", iconFile: "brenu.png" }
    ];

    // Define scenes with their locations and content
    var scenes = {
        overview: {
            lat: 7.9465,
            lng: -1.0232,
            zoom: 7,
            name: 'Overview',
            layers: [baseLayers.osm]
        },
        christian: {
            lat: 5.546861,
            lng: -0.183303,
            zoom: 17,
            name: 'Christiansborg Castle',
            layers: [baseLayers.osm]
        },
        conference: {
            lat: 5.554323,
            lng: -0.193225,
            zoom: 17,
            name: 'Accra Conference Centre',
            layers: [baseLayers.osm]
        },
        theatre: {
            lat: 5.553796,
            lng: -0.20059,
            zoom: 17,
            name: 'National Theatre',
            layers: [baseLayers.osm]
        },
        mausoleum: {
            lat: 5.544658,
            lng: -0.202911,
            zoom: 17,
            name: 'Kwame Nkrumah Mausoleum',
            layers: [baseLayers.osm]
        },
        museumtech: {
            lat: 5.556732,
            lng: -0.206160,
            zoom: 17,
            name: 'Museum of Science and Technology',
            layers: [baseLayers.osm]
        },
        nordsee: {
            lat: 5.528969,
            lng: -0.227011,
            zoom: 17,
            name: 'Nordsee Beach Resort',
            layers: [baseLayers.osm]
        },
        james: {
            lat: 5.533643,
            lng: -0.211343,
            zoom: 17,
            name: 'Fort James',
            layers: [baseLayers.osm]
        },
        square: {
            lat: 5.548003,
            lng: -0.192701,
            zoom: 17,
            name: 'Black Star Square',
            layers: [baseLayers.osm]
        },
        artcent: {
            lat: 5.545632,
            lng: -0.201486,
            zoom: 17,
            name: 'Centre for National Culture',
            layers: [baseLayers.osm]
        },
        mina: {
            lat: 5.08256,
            lng: -1.347915,
            zoom: 16,
            name: 'Elmina Castle',
            layers: [baseLayers.osm]
        },
        mccarthy: {
            lat: 5.105,
            lng: -1.247,
            zoom: 16,
            name: 'Fort McCarthy',
            layers: [baseLayers.osm]
        },
        jago: {
            lat: 5.084636,
            lng: -1.350853,
            zoom: 16,
            name: 'Fort Saint Jago',
            layers: [baseLayers.osm]
        },
        points: {
            lat: 4.744545,
            lng: -2.089237,
            zoom: 13,
            name: 'Cape Three Points',
            layers: [baseLayers.osm]
        },
        dorothea: {
            lat: 4.868,
            lng: -2.241,
            zoom: 16,
            name: 'Fort Dorothea',
            layers: [baseLayers.osm]
        },
        dixcove: {
            lat: 4.789975,
            lng: -1.950406,
            zoom: 16,
            name: 'Fort Metal Cross',
            layers: [baseLayers.osm]
        },
        busua: {
            lat: 4.80902,
            lng: -1.93553,
            zoom: 16,
            name: 'Busua Beach',
            layers: [baseLayers.osm]
        },
        batenstein: {
            lat: 4.821492,
            lng: -1.921041,
            zoom: 16,
            name: 'Fort Batenstein',
            layers: [baseLayers.osm]
        },
        anthony: {
            lat: 4.868036,
            lng: -2.244521,
            zoom: 16,
            name: 'Fort Saint Anthony',
            layers: [baseLayers.osm]
        },
        orange: {
            lat: 4.935641,
            lng: -1.707309,
            zoom: 16,
            name: 'Fort Orange',
            layers: [baseLayers.osm]
        },
        nzulezu: {
            lat: 5.020437,
            lng: -2.597027,
            zoom: 16,
            name: 'Nzulezu Stilt Village',
            layers: [baseLayers.osm]
        },
        sebastian: {
            lat: 5.019781,
            lng: -1.625831,
            zoom: 16,
            name: 'Fort San Sebastian',
            layers: [baseLayers.osm]
        },
        brenu: {
            lat: 5.068054,
            lng: -1.422372,
            zoom: 16,
            name: 'Brenu Beach',
            layers: [baseLayers.osm]
        },
        end: {
            lat: 7.9465,
            lng: -1.0232,
            zoom: 7,
            name: 'The End',
            layers: [baseLayers.osm]
        }
    };

    // Initialize the map
    var map = L.map('map', {
        zoomControl: false,
        attributionControl: false,
        fadeAnimation: true,
        zoomAnimation: true,
        inertia: true,
        inertiaDeceleration: 3000,
        inertiaMaxSpeed: 1500
    }).setView([7.9465, -1.0232], 7);

    // Add the default base layer
    baseLayers.osm.addTo(map);

    L.control.attribution({
            position: 'bottomright',
            prefix: '🇬🇭'
    }).addTo(map).addAttribution('GEOMAPS GHANA CONSULTS © 2025');

    // Add zoom control to the top right
    L.control.zoom({
        position: 'topleft'
    }).addTo(map);

    // Auto-rotation variables
    var autoRotateEnabled = true;
    var rotationInterval;
    var currentRotation = 0;

    // Clustering variables
    var markerClusterGroup;
    var clusterMode = true;
    var customMarkers = L.layerGroup();
    var activeMarker = null;
    var markerIcons = {};

    // Road Network variables
    var roadNetworkLayer = null;
    var roadNetworkVisible = false;
    var roadNetworkData = null;
    var roadNetworkBounds = null;
    var roadNetworkIndex = null;

    // Routing variables
    var routingMode = false;
    var routeWaypoints = [];
    var routeLine = null;
    var routeMarkers = [];
    var currentLocationMarker = null;
    var customLocationMarkers = [];
    var controlsVisible = true;
    var mapClickMode = false;
    var mapClickCounter = 1;
    var useMetric = true;

    // Measurement variables
    var measureControl;
    var drawnItems;
    var measurementMode = null;
    var currentMeasureTool = null;

    // =============================================================================
    // COMBINED ROUTING CONTROL FUNCTIONS
    // =============================================================================

    // Function to update routing status
    function updateRoutingStatus(message, type = 'info') {
        const statusElement = $('#routing-status');
        statusElement.removeClass('info success warning').addClass(type);

        let icon = 'info-circle';
        if (type === 'success') icon = 'check-circle';
        if (type === 'warning') icon = 'exclamation-triangle';

        statusElement.html(`<i class="fas fa-${icon} mr-1"></i>${message}`);
    }

    // Function to update waypoint counter
    function updateWaypointCounter() {
        const count = routeWaypoints.length;
        $('#waypoint-count-display').text(count);

        const counter = $('#waypoint-counter');
        if (count === 0) {
            counter.hide();
        } else {
            counter.show();
            // Change color based on count
            if (count === 1) {
                counter.css({'background': '#fff3cd', 'color': '#856404'});
            } else if (count >= 2) {
                counter.css({'background': '#d4edda', 'color': '#155724'});
            }
        }
    }

    // Enhanced load road network function
    function loadGeoJSONRoadData() {
        $('#loading-indicator').show();
        updateRoutingStatus('Loading road network data...', 'info');

        // Replace with the actual path to your GeoJSON file
        fetch('data/ghana_roads.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(geojsonData => {
                processGeoJSONRoadData(geojsonData);
                $('#loading-indicator').hide();
                updateRoutingStatus('Road network loaded successfully! Ready for offline routing.', 'success');

                // Update UI
                $('#load-roads').html('<i class="fas fa-check"></i> Road Data Loaded');
                $('#load-roads').addClass('success');
                $('#toggle-roads').prop('disabled', false);
                $('#toggle-roads').html('<i class="fas fa-eye"></i> Show Roads');
            })
            .catch((error) => {
                console.error('Error loading GeoJSON:', error);
                $('#loading-indicator').hide();
                updateRoutingStatus('Error loading road data. Using sample network.', 'warning');

                // Fallback to sample data
                console.log('Falling back to sample road network');
                roadNetworkData = generateSampleRoadNetwork();
                createRoadNetworkLayer();

                // Still enable the buttons
                $('#toggle-roads').prop('disabled', false);
                $('#toggle-roads').html('<i class="fas fa-eye"></i> Show Roads');
            });
    }

    // Function to process GeoJSON data into road network format
    function processGeoJSONRoadData(geojsonData) {
        roadNetworkData = [];

        geojsonData.features.forEach(feature => {
            if (feature.geometry && feature.geometry.type === 'LineString') {
                var road = {
                    type: getRoadTypeFromProperties(feature.properties),
                    name: feature.properties?.name || 'Unnamed Road',
                    coordinates: feature.geometry.coordinates.map(coord => [coord[1], coord[0]]), // Convert [lng, lat] to [lat, lng]
                    properties: feature.properties,
                    id: feature.id || Math.random().toString(36).substr(2, 9)
                };

                roadNetworkData.push(road);
            } else if (feature.geometry && feature.geometry.type === 'MultiLineString') {
                // Handle MultiLineString by breaking into individual LineStrings
                feature.geometry.coordinates.forEach(lineCoords => {
                    var road = {
                        type: getRoadTypeFromProperties(feature.properties),
                        name: feature.properties?.name || 'Unnamed Road',
                        coordinates: lineCoords.map(coord => [coord[1], coord[0]]),
                        properties: feature.properties,
                        id: feature.id || Math.random().toString(36).substr(2, 9)
                    };
                    roadNetworkData.push(road);
                });
            }
        });

        console.log(`Loaded ${roadNetworkData.length} road segments`);
        createRoadNetworkLayer();
    }

    // Function to determine road type from GeoJSON properties
    function getRoadTypeFromProperties(properties) {
        if (!properties) return 'tertiary';

        const highway = properties.highway;
        const roadClass = properties.class;

        if (highway === 'motorway' || highway === 'trunk' || roadClass === 'highway') {
            return 'highway';
        } else if (highway === 'primary' || roadClass === 'primary') {
            return 'primary';
        } else if (highway === 'secondary' || roadClass === 'secondary') {
            return 'secondary';
        } else if (highway === 'tertiary' || roadClass === 'tertiary') {
            return 'tertiary';
        } else {
            return 'tertiary'; // default
        }
    }

    // Function to create the road network layer
    function createRoadNetworkLayer() {
        if (roadNetworkLayer) {
            map.removeLayer(roadNetworkLayer);
        }

        roadNetworkLayer = L.layerGroup();

        // Add roads to the layer
        roadNetworkData.forEach(function(road) {
            var polyline = L.polyline(road.coordinates, {
                color: getRoadColor(road.type),
                weight: getRoadWeight(road.type),
                opacity: 0.7,
                className: 'road-network-layer ' + road.type
            }).bindTooltip(road.name || `${road.type} road`, {
                permanent: false,
                direction: 'top'
            });

            roadNetworkLayer.addLayer(polyline);
        });

        // Add road network to map if visible
        if (roadNetworkVisible) {
            roadNetworkLayer.addTo(map);
        }

        // Update road network bounds
        roadNetworkBounds = calculateRoadNetworkBounds();

        // Build spatial index for faster routing
        buildRoadNetworkIndex();

        // Initialize road network routing
        initializeRoadNetworkRouting();
    }

    // Function to generate sample road network (fallback)
    function generateSampleRoadNetwork() {
        var roads = [];

        // Major highways
        roads.push({
            type: 'highway',
            name: 'N1 Highway',
            coordinates: [
                [5.6037, -0.1870], // Accra
                [5.5600, -0.2000],
                [5.5000, -0.2500],
                [5.4000, -0.3000],
                [5.3000, -0.3500],
                [5.2000, -0.4000],
                [5.1000, -0.4500],
                [5.0000, -0.5000],
                [4.9000, -0.5500] // Towards Cape Coast
            ]
        });

        // Primary roads
        roads.push({
            type: 'primary',
            name: 'Primary Road A1',
            coordinates: [
                [5.5500, -0.2000],
                [5.5400, -0.2100],
                [5.5300, -0.2200],
                [5.5200, -0.2300],
                [5.5100, -0.2400]
            ]
        });

        return roads;
    }

    // Function to build spatial index for road network
    function buildRoadNetworkIndex() {
        roadNetworkIndex = new Map();

        roadNetworkData.forEach((road, roadIndex) => {
            road.coordinates.forEach((coord, coordIndex) => {
                // Simple spatial indexing by rounded coordinates
                const key = `${Math.round(coord[0] * 1000)},${Math.round(coord[1] * 1000)}`;
                if (!roadNetworkIndex.has(key)) {
                    roadNetworkIndex.set(key, []);
                }
                roadNetworkIndex.get(key).push({
                    roadIndex: roadIndex,
                    coordIndex: coordIndex,
                    coordinate: coord
                });
            });
        });
    }

    // Initialize road network routing
    function initializeRoadNetworkRouting() {
        // Create a road network router using loaded road data
        offlineRouter = {
            route: function(waypoints, callback) {
                try {
                    if (!roadNetworkData || roadNetworkData.length === 0) {
                        // Fall back to straight-line routing if no road data
                        calculateStraightLineRoute(waypoints, callback);
                        return;
                    }

                    // Use road network for routing
                    calculateRoadNetworkRoute(waypoints, callback);

                } catch (error) {
                    console.error('Routing error:', error);
                    // Fall back to straight-line routing
                    calculateStraightLineRoute(waypoints, callback);
                }
            }
        };
    }

        // Improved road network routing algorithm
    function calculateRoadNetworkRoute(waypoints, callback) {
        try {
            if (!roadNetworkData || roadNetworkData.length === 0) {
                calculateStraightLineRoute(waypoints, callback);
                return;
            }

            const route = {
                name: 'Road Network Route',
                summary: {
                    totalDistance: 0,
                    totalTime: 0
                },
                coordinates: [],
                instructions: [],
                waypoints: waypoints
            };

            // For each segment between waypoints
            for (let i = 0; i < waypoints.length - 1; i++) {
                const start = waypoints[i];
                const end = waypoints[i + 1];

                // Find paths on road network
                const pathResult = findPathOnRoadNetwork(start, end);

                if (pathResult && pathResult.path.length > 0) {
                    // Add path to route coordinates
                    if (i === 0) {
                        route.coordinates.push([start.lat, start.lng]);
                    }

                    // Add the path coordinates
                    pathResult.path.forEach(coord => {
                        route.coordinates.push(coord);
                    });

                    route.coordinates.push([end.lat, end.lng]);

                    // Update statistics
                    route.summary.totalDistance += pathResult.distance;
                    route.summary.totalTime += pathResult.time;

                    // Create instructions for this segment
                    const instructions = createRoadNetworkInstructions(pathResult, i);
                    route.instructions.push(...instructions);
                } else {
                    // Fallback to straight line
                    const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng) * 1000;
                    const time = (distance / 1000 / 50) * 3600; // 50 km/h average

                    route.summary.totalDistance += distance;
                    route.summary.totalTime += time;

                    if (i === 0) {
                        route.coordinates.push([start.lat, start.lng]);
                    }
                    route.coordinates.push([end.lat, end.lng]);

                    const instruction = createOfflineInstruction(start, end, distance / 1000, time, i);
                    route.instructions.push(instruction);
                }
            }

            callback(null, {
                routes: [route],
                waypoints: waypoints
            });

        } catch (error) {
            console.error('Road network routing error:', error);
            calculateStraightLineRoute(waypoints, callback);
        }
    }

    // A* pathfinding algorithm for road network
    function findPathOnRoadNetwork(start, end) {
        // Find closest road segments to start and end
        const startRoad = findClosestRoadSegment(start.lat, start.lng);
        const endRoad = findClosestRoadSegment(end.lat, end.lng);

        if (!startRoad || !endRoad) return null;

        const path = [];
        let totalDistance = 0;

        // Connect start to road network
        path.push([start.lat, start.lng]);
        path.push(startRoad.closestPoint);
        totalDistance += calculateDistance(start.lat, start.lng, startRoad.closestPoint[0], startRoad.closestPoint[1]) * 1000;

        // Follow the road (simplified - just use the road segment)
        const roadPath = extractRoadPath(startRoad, endRoad);
        roadPath.forEach(coord => {
            path.push(coord);
        });

        // Calculate road path distance
        for (let i = 1; i < roadPath.length; i++) {
            totalDistance += calculateDistance(
                roadPath[i-1][0], roadPath[i-1][1],
                roadPath[i][0], roadPath[i][1]
            ) * 1000;
        }

        // Connect to end point
        path.push(endRoad.closestPoint);
        path.push([end.lat, end.lng]);
        totalDistance += calculateDistance(endRoad.closestPoint[0], endRoad.closestPoint[1], end.lat, end.lng) * 1000;

        const time = (totalDistance / 1000 / 50) * 3600; // 50 km/h average

        return {
            path: path,
            distance: totalDistance,
            time: time,
            startRoad: startRoad,
            endRoad: endRoad
        };
    }

    // Improved function to find closest road segment
    function findClosestRoadSegment(lat, lng) {
        if (!roadNetworkData || roadNetworkData.length === 0) return null;

        let closestRoad = null;
        let minDistance = Infinity;
        let closestPoint = null;
        let closestRoadIndex = -1;

        // Search in progressively larger areas
        const searchPrecision = [100, 500, 1000, 5000]; // meters

        for (const precision of searchPrecision) {
            const candidates = findNearbyRoadSegments(lat, lng, precision);

            for (const candidate of candidates) {
                const road = roadNetworkData[candidate.roadIndex];
                const distance = calculateDistanceToRoadSegment(lat, lng, road, candidate.segmentIndex);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestRoad = road;
                    closestPoint = candidate.closestPoint;
                    closestRoadIndex = candidate.roadIndex;
                }
            }

            // If we found a close candidate, break early
            if (minDistance < precision / 2) break;
        }

        return closestRoad ? {
            road: closestRoad,
            roadIndex: closestRoadIndex,
            closestPoint: closestPoint,
            distance: minDistance
        } : null;
    }

    // Function to find nearby road segments using spatial index
    function findNearbyRoadSegments(lat, lng, maxDistanceMeters) {
        const candidates = [];
        const degreeRange = maxDistanceMeters / 111000; // Approximate degrees per meter

        for (let latOffset = -degreeRange; latOffset <= degreeRange; latOffset += degreeRange / 2) {
            for (let lngOffset = -degreeRange; lngOffset <= degreeRange; lngOffset += degreeRange / 2) {
                const searchLat = lat + latOffset;
                const searchLng = lng + lngOffset;
                const key = `${Math.round(searchLat * 1000)},${Math.round(searchLng * 1000)}`;

                if (roadNetworkIndex && roadNetworkIndex.has(key)) {
                    const segments = roadNetworkIndex.get(key);
                    segments.forEach(segment => {
                        const road = roadNetworkData[segment.roadIndex];
                        // Check all segments in this road
                        for (let i = 0; i < road.coordinates.length - 1; i++) {
                            const closestPoint = findClosestPointOnSegment(lat, lng,
                                road.coordinates[i], road.coordinates[i + 1]);
                            const distance = calculateDistance(lat, lng, closestPoint[0], closestPoint[1]);

                            if (distance * 1000 <= maxDistanceMeters) {
                                candidates.push({
                                    roadIndex: segment.roadIndex,
                                    segmentIndex: i,
                                    closestPoint: closestPoint,
                                    distance: distance
                                });
                            }
                        }
                    });
                }
            }
        }

        return candidates;
    }

    // Extract path between two road segments
    function extractRoadPath(startRoad, endRoad) {
        const path = [];

        if (startRoad.roadIndex === endRoad.roadIndex) {
            // Same road - extract segment between points
            const road = roadNetworkData[startRoad.roadIndex];
            const startIndex = findClosestSegmentIndex(road, startRoad.closestPoint);
            const endIndex = findClosestSegmentIndex(road, endRoad.closestPoint);

            if (startIndex <= endIndex) {
                for (let i = startIndex; i <= endIndex; i++) {
                    path.push(road.coordinates[i]);
                }
            } else {
                for (let i = startIndex; i >= endIndex; i--) {
                    path.push(road.coordinates[i]);
                }
            }
        } else {
            // Different roads - simplified: just use start road segment
            const road = roadNetworkData[startRoad.roadIndex];
            const startIndex = findClosestSegmentIndex(road, startRoad.closestPoint);

            // Add remaining coordinates from start road
            for (let i = startIndex; i < road.coordinates.length; i++) {
                path.push(road.coordinates[i]);
            }

            // Add coordinates from end road
            const endRoadData = roadNetworkData[endRoad.roadIndex];
            const endIndex = findClosestSegmentIndex(endRoadData, endRoad.closestPoint);
            for (let i = 0; i <= endIndex; i++) {
                path.push(endRoadData.coordinates[i]);
            }
        }

        return path;
    }

    // Helper function to find closest segment index
    function findClosestSegmentIndex(road, point) {
        let minDistance = Infinity;
        let closestIndex = 0;

        for (let i = 0; i < road.coordinates.length; i++) {
            const distance = calculateDistance(
                point[0], point[1],
                road.coordinates[i][0], road.coordinates[i][1]
            );
            if (distance < minDistance) {
                minDistance = distance;
                closestIndex = i;
            }
        }

        return closestIndex;
    }

    // Improved closest point on segment calculation
    function findClosestPointOnSegment(lat, lng, segStart, segEnd) {
        const x = lat, y = lng;
        const x1 = segStart[0], y1 = segStart[1];
        const x2 = segEnd[0], y2 = segEnd[1];

        const A = x - x1;
        const B = y - y1;
        const C = x2 - x1;
        const D = y2 - y1;

        const dot = A * C + B * D;
        const lenSq = C * C + D * D;
        let param = -1;

        if (lenSq !== 0) {
            param = dot / lenSq;
        }

        let xx, yy;

        if (param < 0) {
            xx = x1;
            yy = y1;
        } else if (param > 1) {
            xx = x2;
            yy = y2;
        } else {
            xx = x1 + param * C;
            yy = y1 + param * D;
        }

        return [xx, yy];
    }

    // Calculate distance to road segment
    function calculateDistanceToRoadSegment(lat, lng, road, segmentIndex) {
        if (segmentIndex === undefined) {
            // Find closest segment in the road
            let minDistance = Infinity;
            for (let i = 0; i < road.coordinates.length - 1; i++) {
                const closestPoint = findClosestPointOnSegment(lat, lng,
                    road.coordinates[i], road.coordinates[i + 1]);
                const distance = calculateDistance(lat, lng, closestPoint[0], closestPoint[1]);
                if (distance < minDistance) {
                    minDistance = distance;
                }
            }
            return minDistance;
        } else {
            const closestPoint = findClosestPointOnSegment(lat, lng,
                road.coordinates[segmentIndex], road.coordinates[segmentIndex + 1]);
            return calculateDistance(lat, lng, closestPoint[0], closestPoint[1]);
        }
    }

    // Create detailed instructions for road network routing
    function createRoadNetworkInstructions(pathResult, segmentIndex) {
        const instructions = [];

        if (segmentIndex === 0) {
            instructions.push({
                type: 'Head',
                distance: 0,
                time: 0,
                text: 'Start your journey',
                direction: 'N',
                roadDirection: 'North'
            });
        }

        // Add instruction for getting onto the road
        if (pathResult.startRoad) {
            const roadName = pathResult.startRoad.road.name || 'the road';
            instructions.push({
                type: 'Continue',
                distance: pathResult.distance * 0.1, // Approximate
                time: pathResult.time * 0.1,
                text: `Continue on ${roadName}`,
                direction: getBearingDirection(pathResult.path[0], pathResult.path[1]),
                roadDirection: getRoadDirection(calculateBearing(
                    pathResult.path[0][0], pathResult.path[0][1],
                    pathResult.path[1][0], pathResult.path[1][1]
                ))
            });
        }

        // Add main route instruction
        instructions.push({
            type: 'Continue',
            distance: pathResult.distance * 0.8,
            time: pathResult.time * 0.8,
            text: 'Follow the road network',
            direction: getBearingDirection(pathResult.path[1], pathResult.path[pathResult.path.length - 2]),
            roadDirection: getRoadDirection(calculateBearing(
                pathResult.path[1][0], pathResult.path[1][1],
                pathResult.path[pathResult.path.length - 2][0], pathResult.path[pathResult.path.length - 2][1]
            ))
        });

        return instructions;
    }

    // Enhanced toggle road network function
    function toggleRoadNetwork() {
        roadNetworkVisible = !roadNetworkVisible;

        if (roadNetworkVisible) {
            if (roadNetworkLayer) {
                roadNetworkLayer.addTo(map);
            }
            $('#toggle-roads').html('<i class="fas fa-eye-slash"></i> Hide Roads');
            $('#toggle-roads').addClass('active');
            updateRoutingStatus('Road network visible on map', 'info');
        } else {
            if (roadNetworkLayer) {
                map.removeLayer(roadNetworkLayer);
            }
            $('#toggle-roads').html('<i class="fas fa-eye"></i> Show Roads');
            $('#toggle-roads').removeClass('active');
            updateRoutingStatus('Road network hidden', 'info');
        }
    }

    // Enhanced toggle routing mode
    function toggleRoutingMode() {
        routingMode = !routingMode;

        if (routingMode) {
            $('#start-route').addClass('active');
            $('#start-route').html('<i class="fas fa-pause-circle"></i> Stop Planning');
            updateRoutingStatus('Click on map or tourist sites to add waypoints', 'info');

            // Enable related buttons
            $('#use-current-location').prop('disabled', false);
            $('#add-custom-location').prop('disabled', false);
            $('#map-click-mode').prop('disabled', false);
            $('#clear-route').prop('disabled', false);

        } else {
            $('#start-route').removeClass('active');
            $('#start-route').html('<i class="fas fa-play-circle"></i> Start Route Planning');
            updateRoutingStatus('Route planning stopped', 'warning');

            // Disable map click mode if active
            if (mapClickMode) {
                toggleMapClickMode();
            }

            // Disable related buttons
            $('#use-current-location').prop('disabled', true);
            $('#add-custom-location').prop('disabled', true);
            $('#map-click-mode').prop('disabled', true);
            $('#clear-route').prop('disabled', true);
        }
    }

    // Enhanced clear route function
    function clearRoute() {
        // Remove route line
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }

        // Remove route markers
        routeMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        routeMarkers = [];

        // Remove current location marker
        if (currentLocationMarker) {
            map.removeLayer(currentLocationMarker);
            currentLocationMarker = null;
        }

        // Remove custom location markers
        customLocationMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        customLocationMarkers = [];

        routeWaypoints = [];
        routingMode = false;

        // Update UI
        $('#start-route').removeClass('active');
        $('#start-route').html('<i class="fas fa-play-circle"></i> Start Route Planning');
        updateRoutingStatus('Route cleared', 'info');
        updateWaypointCounter();

        // Reset map click counter
        mapClickCounter = 1;

        // Disable map click mode if active
        if (mapClickMode) {
            toggleMapClickMode();
        }

        // Hide the route summary
        $('#route-summary-sidebar').hide();

        // Hide loading indicator if shown
        $('#loading-indicator').hide();

        // Disable route planning buttons
        $('#use-current-location').prop('disabled', true);
        $('#add-custom-location').prop('disabled', true);
        $('#map-click-mode').prop('disabled', true);
        $('#clear-route').prop('disabled', true);
    }

    // Enhanced add location to route function
    function addLocationToRoute(lat, lng, name, isCurrentLocation) {
        // Close any open popup immediately to prevent double popups
        map.closePopup();

        // Create marker for the location
        var markerColor = isCurrentLocation ? '#4285F4' : '#9b59b6';
        var marker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-location-marker',
                html: '<div style="background-color: ' + markerColor + '; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            })
        });

        if (isCurrentLocation) {
            // Remove previous current location marker if exists
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            currentLocationMarker = marker;
        } else {
            customLocationMarkers.push(marker);
        }

        marker.addTo(map);

        // Add to route waypoints
        routeWaypoints.push(L.latLng(lat, lng));

        // Update waypoint counter
        updateWaypointCounter();

        // Show brief notification
        showBriefNotification(name + ' added to route', [lat, lng]);

        // Calculate route if we have at least 2 waypoints
        if (routeWaypoints.length >= 2) {
            calculateRoute();
            updateRoutingStatus(`Route calculated with ${routeWaypoints.length} waypoints`, 'success');
        } else if (routeWaypoints.length === 1) {
            updateRoutingStatus('Added first waypoint. Add more points to calculate route.', 'info');
        }

        // Update the sidebar summary
        updateRouteSummaryWithData({
            summary: {
                totalDistance: 0,
                totalTime: 0
            },
            instructions: []
        });
    }

    // Enhanced calculate route function
    function calculateRoute() {
        if (routeWaypoints.length < 2) return;

        // Clear existing route if any
        if (routeLine) {
            map.removeLayer(routeLine);
        }

        // Remove existing route markers
        routeMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        routeMarkers = [];

        // Show loading indicator briefly
        $('#loading-indicator').show();
        updateRoutingStatus('Calculating optimal route...', 'info');

        // Use appropriate router based on road network availability
        offlineRouter.route(routeWaypoints, function(error, result) {
            $('#loading-indicator').hide();

            if (error) {
                console.error('Routing error:', error);
                updateRoutingStatus('Could not calculate route. Please try again.', 'warning');
                return;
            }

            if (result && result.routes && result.routes.length > 0) {
                var route = result.routes[0];
                displayRoute(route);
                updateRouteSummaryWithData(route);
                updateRoutingStatus(`Route calculated: ${(route.summary.totalDistance / 1000).toFixed(1)} km`, 'success');
            }
        });
    }

    // Function to display route on map
    function displayRoute(route) {
        // Create polyline for the route
        routeLine = L.polyline(route.coordinates, {
            color: '#3498db',
            weight: 6,
            opacity: 0.7,
            lineCap: 'round',
            lineJoin: 'round'
        }).addTo(map);

        // Add a white outline for better visibility
        var outline = L.polyline(route.coordinates, {
            color: 'white',
            weight: 8,
            opacity: 0.9,
            lineCap: 'round',
            lineJoin: 'round'
        }).addTo(map);

        // Create route markers
        routeWaypoints.forEach(function(waypoint, index) {
            var color = index === 0 ? '#2ecc71' : (index === routeWaypoints.length - 1 ? '#e74c3c' : '#f39c12');
            var marker = L.marker([waypoint.lat, waypoint.lng], {
                icon: L.divIcon({
                    className: 'route-marker',
                    html: '<div style="background-color: ' + color + '; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            });

            var stopName = getLocationName(waypoint);
            marker.bindTooltip('Stop ' + (index + 1) + ': ' + stopName, {
                permanent: false,
                direction: 'top',
                className: 'route-tooltip'
            });

            marker.addTo(map);
            routeMarkers.push(marker);
        });

        // Fit map to show the entire route
        var routeBounds = routeLine.getBounds();
        map.fitBounds(routeBounds, {
            padding: [20, 20],
            maxZoom: 16
        });
    }

    // Function to update route summary with data
    function updateRouteSummaryWithData(route) {
        if (!route) return;

        // Show the route summary
        $('#route-summary-sidebar').show();

        var totalDistance = route.summary.totalDistance; // in meters
        var totalTime = route.summary.totalTime; // in seconds

        // Update statistics with unit conversion
        updateDistanceDisplayFromData(totalDistance, totalTime, route.instructions);

        // Update waypoints list
        var waypointList = $('#waypoint-list');
        waypointList.empty();

        routeWaypoints.forEach(function(waypoint, index) {
            var name = getLocationName(waypoint);
            var waypointItem = $('<div class="waypoint-item"></div>');

            waypointItem.html(`
                <div class="waypoint-number">${index + 1}</div>
                <div class="waypoint-details">
                    <div class="waypoint-name">${name}</div>
                    <div class="waypoint-coords">${waypoint.lat.toFixed(6)}, ${waypoint.lng.toFixed(6)}</div>
                </div>
            `);

            waypointList.append(waypointItem);
        });

        // Update segments list with instructions
        updateSegmentsListFromData(route.instructions);

        // Scroll the sidebar to show the route summary
        $('.storymap-story').animate({
            scrollTop: $('#route-summary-sidebar').offset().top - $('.storymap-story').offset().top + $('.storymap-story').scrollTop() - 20
        }, 500);
    }

    // Function to update distance display from data
    function updateDistanceDisplayFromData(totalDistanceMeters, totalTimeSeconds, instructions) {
        var useMiles = $('#use-miles').hasClass('active');

        if (useMiles) {
            // Convert to miles
            var totalDistanceMiles = totalDistanceMeters * 0.000621371;

            if (totalDistanceMiles < 0.1) {
                var totalDistanceFeet = totalDistanceMiles * 5280;
                $('#total-distance').text(totalDistanceFeet.toFixed(0) + ' ft');
            } else {
                $('#total-distance').text(totalDistanceMiles.toFixed(1) + ' mi');
            }

            // Convert time to minutes
            var totalTimeMinutes = Math.round(totalTimeSeconds / 60);
            if (totalTimeMinutes < 60) {
                $('#total-time').text(totalTimeMinutes + ' min');
            } else {
                var hours = Math.floor(totalTimeMinutes / 60);
                var minutes = totalTimeMinutes % 60;
                $('#total-time').text(hours + 'h ' + minutes + 'm');
            }
        } else {
            // Use kilometers and meters
            if (totalDistanceMeters < 1000) {
                $('#total-distance').text(totalDistanceMeters.toFixed(0) + ' m');
            } else {
                $('#total-distance').text((totalDistanceMeters / 1000).toFixed(1) + ' km');
            }

            // Convert time to minutes
            var totalTimeMinutes = Math.round(totalTimeSeconds / 60);
            if (totalTimeMinutes < 60) {
                $('#total-time').text(totalTimeMinutes + ' min');
            } else {
                var hours = Math.floor(totalTimeMinutes / 60);
                var minutes = totalTimeMinutes % 60;
                $('#total-time').text(hours + 'h ' + minutes + 'm');
            }
        }

        $('#waypoint-count').text(routeWaypoints.length);
        $('#segment-count').text(instructions ? instructions.length : 0);
    }

    // Function to update segments list with instructions
    function updateSegmentsListFromData(instructions) {
        var segmentList = $('#segment-list');
        segmentList.empty();

        if (!instructions || instructions.length === 0) {
            segmentList.html('<div class="text-muted">No route instructions available</div>');
            return;
        }

        instructions.forEach(function(instruction, index) {
            var segmentItem = $('<div class="segment-item"></div>');
            var distance = instruction.distance; // in meters
            var time = instruction.time; // in seconds
            var text = instruction.text;
            var direction = instruction.direction;
            var roadDirection = instruction.roadDirection;

            var distanceText, timeText;
            var useMiles = $('#use-miles').hasClass('active');

            if (useMiles) {
                // Convert to miles/feet
                if (distance < 160.934) { // Less than 0.1 miles in meters
                    var distanceFeet = distance * 3.28084;
                    distanceText = distanceFeet.toFixed(0) + ' ft';
                } else {
                    var distanceMiles = distance * 0.000621371;
                    distanceText = distanceMiles.toFixed(1) + ' mi';
                }
            } else {
                // Use meters/kilometers
                if (distance < 1000) {
                    distanceText = distance.toFixed(0) + ' m';
                } else {
                    distanceText = (distance / 1000).toFixed(1) + ' km';
                }
            }

            // Convert time to minutes
            var timeMinutes = Math.round(time / 60);
            if (timeMinutes < 1 && time > 0) {
                timeText = '< 1 min';
            } else {
                timeText = timeMinutes + ' min';
            }

            // Get direction icon
            var directionIcon = getDirectionIcon(instruction.type);

            segmentItem.html(`
                <div class="segment-header">
                    <span class="direction-icon">${directionIcon}</span>
                    <strong>Segment ${index + 1}</strong>
                </div>
                <div class="segment-details">
                    <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px;">
                        <span class="segment-distance">${distanceText}</span>
                        <span class="segment-time">${timeText}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 5px;">
                        <span class="segment-direction" title="Bearing: ${direction}">
                            <i class="fas fa-compass"></i> ${direction}
                        </span>
                        <span class="road-info">
                            <i class="fas fa-road mr-1"></i>${roadNetworkData ? 'Road Network' : 'Direct Route'}
                        </span>
                    </div>
                    <div class="road-direction">
                        <i class="fas fa-info-circle mr-1"></i>${text}
                    </div>
                </div>
            `);

            segmentList.append(segmentItem);
        });
    }

    // Function to calculate straight line route (fallback)
    function calculateStraightLineRoute(waypoints, callback) {
        var route = {
            name: 'Straight Line Route',
            summary: {
                totalDistance: 0,
                totalTime: 0
            },
            coordinates: [],
            instructions: [],
            waypoints: waypoints
        };

        // Calculate total distance and create coordinates
        for (var i = 0; i < waypoints.length - 1; i++) {
            var start = waypoints[i];
            var end = waypoints[i+1];

            // Calculate distance between points
            var distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
            route.summary.totalDistance += distance * 1000; // Convert to meters

            // Estimate time (assuming 50 km/h average speed)
            var time = (distance / 50) * 3600; // Convert to seconds
            route.summary.totalTime += time;

            // Add coordinates for this segment
            if (i === 0) {
                route.coordinates.push([start.lat, start.lng]);
            }
            route.coordinates.push([end.lat, end.lng]);

            // Create instruction for this segment
            var instruction = createOfflineInstruction(start, end, distance, time, i);
            route.instructions.push(instruction);
        }

        // Return the route
        callback(null, {
            routes: [route],
            waypoints: waypoints
        });
    }

    // Function to create offline routing instructions
    function createOfflineInstruction(start, end, distance, time, segmentIndex) {
        var bearing = calculateBearing(start.lat, start.lng, end.lat, end.lng);
        var direction = getCardinalDirection(bearing);
        var roadDirection = getRoadDirection(bearing);

        var instructionText = '';
        var instructionType = '';

        if (segmentIndex === 0) {
            instructionText = 'Start heading ' + roadDirection.toLowerCase() + ' toward destination';
            instructionType = 'Head';
        } else {
            instructionText = 'Continue ' + roadDirection.toLowerCase();
            instructionType = 'Continue';
        }

        return {
            type: instructionType,
            distance: distance * 1000, // Convert to meters
            time: time, // in seconds
            text: instructionText,
            direction: direction,
            roadDirection: roadDirection
        };
    }

    // Function to get road color based on type
    function getRoadColor(type) {
        switch(type) {
            case 'highway': return '#e74c3c';
            case 'primary': return '#f39c12';
            case 'secondary': return '#3498db';
            case 'tertiary': return '#2ecc71';
            default: return '#666';
        }
    }

    // Function to get road weight based on type
    function getRoadWeight(type) {
        switch(type) {
            case 'highway': return 3;
            case 'primary': return 2.5;
            case 'secondary': return 2;
            case 'tertiary': return 1.5;
            default: return 1;
        }
    }

    // Function to calculate road network bounds
    function calculateRoadNetworkBounds() {
        if (!roadNetworkData || roadNetworkData.length === 0) return null;

        var bounds = L.latLngBounds();

        roadNetworkData.forEach(function(road) {
            road.coordinates.forEach(function(coord) {
                bounds.extend(coord);
            });
        });

        return bounds;
    }

    // Update event listeners for combined controls
    function initializeCombinedRoutingControls() {
        // Load road data
        $('#load-roads').click(function() {
            loadGeoJSONRoadData();
        });

        // Toggle road network visibility
        $('#toggle-roads').click(function() {
            if (!$(this).prop('disabled')) {
                toggleRoadNetwork();
            }
        });

        // Start/stop route planning
        $('#start-route').click(function() {
            toggleRoutingMode();
        });

        // Use current location
        $('#use-current-location').click(function() {
            if ($(this).prop('disabled')) return;

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            $('#loading-indicator').show();
            updateRoutingStatus('Getting your current location...', 'info');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    // Add current location as first waypoint
                    addLocationToRoute(lat, lng, 'My Current Location', true);

                    $('#loading-indicator').hide();
                    showBriefNotification('Your current location added to route', [lat, lng]);

                    // Ensure routing mode is enabled
                    if (!routingMode) {
                        toggleRoutingMode();
                    }
                },
                function(error) {
                    $('#loading-indicator').hide();
                    updateRoutingStatus('Unable to retrieve your location', 'warning');
                    alert('Unable to retrieve your location: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        });

        // Add custom location
        $('#add-custom-location').click(function() {
            if (!$(this).prop('disabled')) {
                $('#custom-location-modal').css('display', 'flex');
            }
        });

        // Map click mode
        $('#map-click-mode').click(function() {
            if (!$(this).prop('disabled')) {
                toggleMapClickMode();
            }
        });

        // Clear route
        $('#clear-route').click(function() {
            if (!$(this).prop('disabled')) {
                clearRoute();
            }
        });

        // Initially disable route planning buttons until routing mode is started
        $('#use-current-location').prop('disabled', true);
        $('#add-custom-location').prop('disabled', true);
        $('#map-click-mode').prop('disabled', true);
        $('#clear-route').prop('disabled', true);
    }

    // Initialize the combined controls when the page loads
    initializeCombinedRoutingControls();

    // =============================================================================
    // REMAINING EXISTING CODE
    // =============================================================================

    // Function to show brief notification without popup
    function showBriefNotification(message, latlng) {
        // Create a temporary notification
        var notification = L.marker(latlng, {
            icon: L.divIcon({
                className: 'notification-marker',
                html: '<div style="background: rgba(52, 152, 219, 0.9); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">' + message + '</div>',
                iconSize: [message.length * 7, 30],
                iconAnchor: [message.length * 3.5, 15]
            })
        }).addTo(map);

        // Remove after 2 seconds
        setTimeout(function() {
            map.removeLayer(notification);
        }, 2000);
    }

    // Function to get location name
    function getLocationName(latlng) {
        // Check if it's a tourist site
        var site = touristSites.find(s => s.lat === latlng.lat && s.lng === latlng.lng);
        if (site) return site.name;

        // Check if it's the current location
        if (currentLocationMarker &&
            currentLocationMarker.getLatLng().lat === latlng.lat &&
            currentLocationMarker.getLatLng().lng === latlng.lng) {
            return 'My Current Location';
        }

        // Check if it's a custom location
        for (var i = 0; i < customLocationMarkers.length; i++) {
            var marker = customLocationMarkers[i];
            if (marker.getLatLng().lat === latlng.lat &&
                marker.getLatLng().lng === latlng.lng) {
                return 'Custom Location ' + (i+1);
            }
        }

        // Check if it's a map click location
        if (latlng.name && latlng.name.startsWith('Map Location')) {
            return latlng.name;
        }

        // Default name
        return 'Point ' + (routeWaypoints.findIndex(wp => wp.lat === latlng.lat && wp.lng === latlng.lng) + 1);
    }

    // Function to enable clustering
    function enableClustering() {
        // Remove individual markers
        if (map.hasLayer(customMarkers)) {
            map.removeLayer(customMarkers);
        }

        // Create marker cluster group
        markerClusterGroup = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true,
            iconCreateFunction: function(cluster) {
                var count = cluster.getChildCount();
                var size = count < 10 ? 'small' : count < 100 ? 'medium' : 'large';

                return L.divIcon({
                    html: '<div style="background-color: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + count + '</div>',
                    className: 'marker-cluster marker-cluster-' + size,
                    iconSize: L.point(40, 40)
                });
            }
        });

        // Add all markers to cluster group
        customMarkers.eachLayer(function(marker) {
            markerClusterGroup.addLayer(marker);
        });

        // Add cluster group to map
        map.addLayer(markerClusterGroup);
    }

    // Function to disable clustering
    function disableClustering() {
        // Remove cluster group
        if (markerClusterGroup && map.hasLayer(markerClusterGroup)) {
            map.removeLayer(markerClusterGroup);
        }

        // Add individual markers
        map.addLayer(customMarkers);
    }

    // Function to handle map clicks for adding custom locations
    function setupMapClickHandler() {
        map.on('click', function(e) {
            if (mapClickMode && routingMode) {
                var lat = e.latlng.lat;
                var lng = e.latlng.lng;
                var name = 'Map Location ' + mapClickCounter;

                // Store the name with the waypoint for later retrieval
                var waypoint = L.latLng(lat, lng);
                waypoint.name = name;

                addLocationToRoute(lat, lng, name, false);
                mapClickCounter++;
            }
        });
    }

    // Function to toggle map click mode
    function toggleMapClickMode() {
        mapClickMode = !mapClickMode;

        if (mapClickMode) {
            // Enable map click mode
            $('#map-click-mode').addClass('active');
            $('#map-click-indicator').show();
            updateRoutingStatus('Click anywhere on the map to add locations to your route', 'info');

            // Ensure routing mode is enabled
            if (!routingMode) {
                toggleRoutingMode();
            }
        } else {
            // Disable map click mode
            $('#map-click-mode').removeClass('active');
            $('#map-click-indicator').hide();
            updateRoutingStatus('Click on tourist sites to add them to your route', 'info');
        }
    }

    // Function to highlight focused location and dim others
    function highlightFocusedLocation(focusedScene) {
        // Reset all markers to normal state
        customMarkers.eachLayer(function(marker) {
            var element = marker.getElement();
            if (element) {
                element.classList.remove('focused', 'dimmed');
            }
        });

        // Find the marker for the focused scene and highlight it
        customMarkers.eachLayer(function(marker) {
            // Check if this marker corresponds to the focused scene
            var markerLatLng = marker.getLatLng();
            var focusedSite = touristSites.find(site => site.scene === focusedScene);

            if (focusedSite &&
                markerLatLng.lat === focusedSite.lat &&
                markerLatLng.lng === focusedSite.lng) {

                // Highlight the focused marker
                var element = marker.getElement();
                if (element) {
                    element.classList.add('focused');
                }
            } else {
                // Dim all other markers
                var element = marker.getElement();
                if (element) {
                    element.classList.add('dimmed');
                }
            }
        });
    }

    // Function to reset all markers to normal state
    function resetMarkerHighlights() {
        customMarkers.eachLayer(function(marker) {
            var element = marker.getElement();
            if (element) {
                element.classList.remove('focused', 'dimmed');
            }
        });
    }

    // Function to create and resize icon
    function createResizedIcon(iconPath, color, size) {
        return new Promise(function(resolve, reject) {
            var img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                // Create canvas for resizing
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                // Draw circular background
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();

                // Draw image in circle (clipping)
                ctx.save();
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 3, 0, 2 * Math.PI);
                ctx.clip();

                // Calculate dimensions to maintain aspect ratio
                var ratio = Math.min(size / img.width, size / img.height);
                var newWidth = img.width * ratio;
                var newHeight = img.height * ratio;
                var x = (size - newWidth) / 2;
                var y = (size - newHeight) / 2;

                ctx.drawImage(img, x, y, newWidth, newHeight);
                ctx.restore();

                // Add white border
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 1.5, 0, 2 * Math.PI);
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'white';
                ctx.stroke();

                resolve(canvas.toDataURL());
            };
            img.onerror = function() {
                // If image fails to load, create a colored circle as fallback
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 2, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();

                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 1.5, 0, 2 * Math.PI);
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'white';
                ctx.stroke();

                resolve(canvas.toDataURL());
            };
            img.src = iconPath;
        });
    }

    // Function to load all icons
    async function loadAllIcons() {
        $('#loading-indicator').show();

        for (const site of touristSites) {
            var color;
            var size = 50;

            switch(site.type) {
                case 'historical': color = '#e74c3c'; break;
                case 'cultural': color = '#f39c12'; break;
                case 'beach': color = '#27ae60'; break;
                case 'natural': color = '#2ecc71'; break;
                default: color = '#3498db';
            }

            // Try to load from local folder first, then fallback to placeholder
            var iconPath = 'img/' + site.iconFile;

            try {
                // Create resized icon
                var iconUrl = await createResizedIcon(iconPath, color, size);
                markerIcons[site.scene] = iconUrl;
            } catch (error) {
                console.warn('Failed to load icon for ' + site.name + ', using fallback');
                // Use fallback colored circle
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 2, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();

                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 1.5, 0, 2 * Math.PI);
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'white';
                ctx.stroke();

                markerIcons[site.scene] = canvas.toDataURL();
            }
        }

        $('#loading-indicator').hide();
        createMarkers();
    }

    // Function to create markers after icons are loaded
    function createMarkers() {
        touristSites.forEach(function(site) {
            var color;

            switch(site.type) {
                case 'historical': color = '#e74c3c'; break;
                case 'cultural': color = '#f39c12'; break;
                case 'beach': color = '#27ae60'; break;
                case 'natural': color = '#2ecc71'; break;
                default: color = '#3498db';
            }

            // Create custom marker with resized icon
            var customIcon = L.divIcon({
                className: 'custom-marker marker-circle',
                html: '<div style="background-image: url(' + markerIcons[site.scene] + '); width: 50px; height: 50px; background-size: cover; background-position: center; border-radius: 50%;"></div>',
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });

            var marker = L.marker([site.lat, site.lng], {
                icon: customIcon
            });

            // Create popup content WITHOUT routing buttons when in routing mode
            var popupContent = '<div class="custom-popup"><b>' + site.name + '</b><br>' +
                              '<span style="color: ' + color + '; font-weight: bold;">' +
                              site.type.charAt(0).toUpperCase() + site.type.slice(1) + ' Site</span><br>' +
                              '<button class="btn btn-sm btn-primary mt-2" onclick="goToScene(\'' + site.scene + '\'); map.closePopup();">View Details</button>' +
                              '<button class="btn btn-sm btn-success mt-2 ml-1" onclick="addToRoute(\'' + site.scene + '\'); map.closePopup();">Add to Route</button></div>';

            // Bind popup to marker
            marker.bindPopup(popupContent);

            // Add click event to marker
            marker.on('click', function(e) {
                if (routingMode) {
                    // In routing mode, add to route and don't show popup
                    e.originalEvent.stopPropagation(); // Prevent popup from opening
                    addToRoute(site.scene);
                }
                // In normal mode, let the popup open normally
            });

            customMarkers.addLayer(marker);
        });

        // Start with clustering enabled
        enableClustering();

        // Setup map click handler for adding custom locations
        setupMapClickHandler();

        // Initialize measurement tools
        initializeMeasurements();
    }

    // Function to add site to route
    function addToRoute(sceneName) {
        if (!routingMode) return;

        var site = touristSites.find(s => s.scene === sceneName);
        if (!site) return;

        // Close any open popup immediately to prevent double popups
        map.closePopup();

        // Check if site is already in route
        var existingIndex = routeWaypoints.findIndex(wp =>
            wp.lat === site.lat && wp.lng === site.lng);

        if (existingIndex === -1) {
            // Add to route
            routeWaypoints.push(L.latLng(site.lat, site.lng));

            // Show brief notification
            showBriefNotification(site.name + ' added to route', [site.lat, site.lng]);

            // Calculate route if we have at least 2 waypoints
            if (routeWaypoints.length >= 2) {
                calculateRoute();
            }
        } else {
            // Show brief notification that site is already in route
            showBriefNotification(site.name + ' is already in your route', [site.lat, site.lng]);
        }
    }

    // Initialize measurement functionality
    function initializeMeasurements() {
        // Create a layer group for drawn items
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize the draw control
        measureControl = new L.Control.Draw({
            position: 'topleft',
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: {
                        color: '#3498db',
                        fillColor: 'rgba(52, 152, 219, 0.2)'
                    }
                },
                polyline: {
                    metric: useMetric,
                    shapeOptions: {
                        color: '#e74c3c',
                        stroke: true,
                        weight: 3
                    }
                },
                circle: false,
                rectangle: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });

        // Add draw control to map (initially hidden)
        map.addControl(measureControl);

        // Hide the draw control by default
        $('.leaflet-draw-section').hide();

        // Set up measurement event listeners
        setupMeasurementEvents();
    }

    // Function to format distance for measurements
    function formatDistance(meters) {
        if (useMetric) {
            if (meters >= 1000) {
                return (meters / 1000).toFixed(2) + ' km';
            } else {
                return meters.toFixed(1) + ' m';
            }
        } else {
            var feet = meters * 3.28084;
            if (feet >= 5280) {
                return (feet / 5280).toFixed(2) + ' miles';
            } else {
                return feet.toFixed(1) + ' ft';
            }
        }
    }

    // Function to format area for measurements
    function formatArea(sqMeters) {
        if (useMetric) {
            if (sqMeters >= 1000000) {
                return (sqMeters / 1000000).toFixed(3) + ' km²';
            } else if (sqMeters >= 10000) {
                return (sqMeters / 10000).toFixed(2) + ' hectares';
            } else {
                return sqMeters.toFixed(1) + ' m²';
            }
        } else {
            var sqFeet = sqMeters * 10.7639;
            if (sqFeet >= 43560) {
                return (sqFeet / 43560).toFixed(3) + ' acres';
            } else if (sqFeet >= 4356) {
                return (sqFeet / 4356).toFixed(2) + ' hectares';
            } else {
                return sqFeet.toFixed(1) + ' ft²';
            }
        }
    }

    // Function to start distance measurement
    function startDistanceMeasurement() {
        if (currentMeasureTool) {
            currentMeasureTool.disable();
        }

        measurementMode = 'distance';
        $('.measurement-btn').removeClass('active');
        $('#measure-distance').addClass('active');
        $('#measurement-results').show();
        $('#area-result').hide();
        $('#distance-result').html('Click on map to start measuring distance');

        // Enable polyline drawing
        currentMeasureTool = new L.Draw.Polyline(map, measureControl.options.draw.polyline);
        currentMeasureTool.enable();
    }

    // Function to start area measurement
    function startAreaMeasurement() {
        if (currentMeasureTool) {
            currentMeasureTool.disable();
        }

        measurementMode = 'area';
        $('.measurement-btn').removeClass('active');
        $('#measure-area').addClass('active');
        $('#measurement-results').show();
        $('#distance-result').hide();
        $('#area-result').html('Click on map to start measuring area');

        // Enable polygon drawing
        currentMeasureTool = new L.Draw.Polygon(map, measureControl.options.draw.polygon);
        currentMeasureTool.enable();
    }

    // Function to clear measurements
    function clearMeasurements() {
        if (currentMeasureTool) {
            currentMeasureTool.disable();
            currentMeasureTool = null;
        }

        measurementMode = null;
        $('.measurement-btn').removeClass('active');
        $('#measurement-results').hide();
        drawnItems.clearLayers();
    }

    // Set up measurement event listeners
    function setupMeasurementEvents() {
        // Event listeners for measurement controls
        $('#measure-distance').click(function() {
            if (measurementMode === 'distance') {
                clearMeasurements();
            } else {
                startDistanceMeasurement();
            }
        });

        $('#measure-area').click(function() {
            if (measurementMode === 'area') {
                clearMeasurements();
            } else {
                startAreaMeasurement();
            }
        });

        $('#clear-measurements').click(function() {
            clearMeasurements();
        });

        // Unit toggle functionality for measurements
        $('.measurement-unit-toggle .unit-btn').click(function() {
            var unit = $(this).data('unit');
            $('.measurement-unit-toggle .unit-btn').removeClass('active');
            $(this).addClass('active');

            useMetric = (unit === 'metric');

            // Update existing measurements if any
            updateMeasurementDisplay();
        });

        // Map events for measurements
        map.on('draw:created', function(e) {
            var type = e.layerType;
            var layer = e.layer;

            // Add custom styling
            if (type === 'polyline') {
                layer.setStyle({
                    color: '#e74c3c',
                    weight: 3,
                    dashArray: '5, 5'
                });

                // Calculate and display distance
                var distance = calculateLineDistance(layer);
                $('#distance-result').html('<strong>Distance:</strong> ' + formatDistance(distance));

            } else if (type === 'polygon') {
                layer.setStyle({
                    color: '#3498db',
                    weight: 2,
                    fillColor: 'rgba(52, 152, 219, 0.2)',
                    fillOpacity: 0.5
                });

                // Calculate and display area
                var area = calculatePolygonArea(layer);
                $('#area-result').html('<strong>Area:</strong> ' + formatArea(area));
                $('#area-result').show();
            }

            drawnItems.addLayer(layer);
        });

        map.on('draw:edited', function(e) {
            var layers = e.layers;
            layers.eachLayer(function(layer) {
                if (layer instanceof L.Polyline) {
                    var distance = calculateLineDistance(layer);
                    $('#distance-result').html('<strong>Distance:</strong> ' + formatDistance(distance));
                } else if (layer instanceof L.Polygon) {
                    var area = calculatePolygonArea(layer);
                    $('#area-result').html('<strong>Area:</strong> ' + formatArea(area));
                }
            });
        });
    }

    // Function to calculate line distance for measurements
    function calculateLineDistance(layer) {
        var latlngs = layer.getLatLngs();
        var distance = 0;

        for (var i = 0; i < latlngs.length - 1; i++) {
            distance += latlngs[i].distanceTo(latlngs[i + 1]);
        }

        return distance;
    }

    // Function to calculate polygon area for measurements
    function calculatePolygonArea(layer) {
        var latlngs = layer.getLatLngs()[0]; // Get the outer ring
        return L.GeometryUtil.geodesicArea(latlngs);
    }

    // Function to update measurement display when units change
    function updateMeasurementDisplay() {
        drawnItems.eachLayer(function(layer) {
            if (layer instanceof L.Polyline) {
                var distance = calculateLineDistance(layer);
                $('#distance-result').html('<strong>Distance:</strong> ' + formatDistance(distance));
            } else if (layer instanceof L.Polygon) {
                var area = calculatePolygonArea(layer);
                $('#area-result').html('<strong>Area:</strong> ' + formatArea(area));
            }
        });
    }

    // Start loading icons
    loadAllIcons();

    // Populate site list
    var siteListContainer = document.getElementById('site-list-container');
    touristSites.forEach(function(site, index) {
        var siteItem = document.createElement('div');
        siteItem.className = 'site-item';

        var color;
        switch(site.type) {
            case 'historical': color = '#e74c3c'; break;
            case 'cultural': color = '#f39c12'; break;
            case 'beach': color = '#27ae60'; break;
            case 'natural': color = '#2ecc71'; break;
            default: color = '#3498db';
        }

        siteItem.innerHTML = '<div class="site-type-icon" style="background-color: ' + color + '"></div>' + site.name;
        siteItem.addEventListener('click', function() {
            if (routingMode) {
                addToRoute(site.scene);
            } else {
                goToScene(site.scene);
            }
        });
        siteListContainer.appendChild(siteItem);
    });

    // Scene navigation
    var sceneOrder = [
        'overview', 'christian', 'conference', 'theatre', 'mausoleum', 
        'museumtech', 'nordsee', 'james', 'square', 'artcent', 
        'mina', 'mccarthy', 'jago', 'points', 'dorothea', 
        'dixcove', 'busua', 'batenstein', 'anthony', 'orange', 
        'nzulezu', 'sebastian', 'brenu', 'end'
    ];
    var currentSceneIndex = 0;

    // Function to update the map for a scene
    function goToScene(sceneName) {
        console.log('Going to scene:', sceneName);
        
        var scene = scenes[sceneName];
        if (!scene) {
            console.error('Scene not found:', sceneName);
            return;
        }

        // Stop any existing rotation
        stopAutoRotation();

        // Disable clustering when starting the tour
        if (sceneName !== 'overview' && clusterMode) {
            clusterMode = false;
            $('.cluster-btn').removeClass('active');
            $('#cluster-off').addClass('active');
            disableClustering();
        }

        // Update map view with smooth zoom and pan
        map.flyTo([scene.lat, scene.lng], scene.zoom, {
            duration: 2,
            easeLinearity: 0.25
        });

        // Update active scene in navigation
        $('[data-scene]').removeClass('active');
        console.log('Removed active class from all scenes');

        // Add active class to target scene
        var targetScene = $('[data-scene="' + sceneName + '"]');
        if (targetScene.length) {
            targetScene.addClass('active');
            console.log('Added active class to:', sceneName);
        } else {
            console.error('Scene element not found for:', sceneName);
        }

        // Update scene indicator
        $('#current-scene').text(scene.name);

        // Update progress bar
        currentSceneIndex = sceneOrder.indexOf(sceneName);
        var progress = (currentSceneIndex / (sceneOrder.length - 1)) * 100;
        $('#tour-progress').css('width', progress + '%');

        // Update site counter
        var siteIndex = touristSites.findIndex(site => site.scene === sceneName);
        if (siteIndex !== -1) {
            $('#site-counter').text((siteIndex + 1) + '/' + touristSites.length + ' Sites');
        }

        // Update active site in list
        $('.site-item').removeClass('active');
        var activeSite = touristSites.find(site => site.scene === sceneName);
        if (activeSite) {
            $('.site-item').each(function() {
                if ($(this).text().trim() === activeSite.name) {
                    $(this).addClass('active');
                }
            });

            // Highlight focused location and dim others
            if (sceneName !== 'overview' && sceneName !== 'end') {
                highlightFocusedLocation(sceneName);
            } else {
                resetMarkerHighlights();
            }
        }

        // Start auto-rotation if enabled (except for overview and end scenes)
        if (autoRotateEnabled && sceneName !== 'overview' && sceneName !== 'end') {
            startAutoRotation([scene.lat, scene.lng], scene.zoom);
        }

        // Scroll to the active scene in the story panel
        $('.storymap-story').animate({
            scrollTop: $('[data-scene="' + sceneName + '"]').offset().top - $('.storymap-story').offset().top + $('.storymap-story').scrollTop()
        }, 500);

        // Close search results if open
        $('#search-results').hide();
    }

    // Function to start auto-rotation
    function startAutoRotation(center, zoom) {
        if (!autoRotateEnabled) return;

        clearInterval(rotationInterval);

        rotationInterval = setInterval(function() {
            currentRotation = (currentRotation + 0.5) % 360;
            map.setView(center, zoom, {
                animate: true,
                duration: 0.1,
                easeLinearity: 0.25
            });
        }, 50);
    }

    // Function to stop auto-rotation
    function stopAutoRotation() {
        clearInterval(rotationInterval);
    }

    // Base map switching functionality
    $('.basemap-btn').click(function() {
        var basemapType = $(this).data('basemap');

        // Update active button
        $('.basemap-btn').removeClass('active');
        $(this).addClass('active');

        // Remove all base layers
        map.eachLayer(function(layer) {
            if (layer instanceof L.TileLayer) {
                map.removeLayer(layer);
            }
        });

        // Add the selected base layer
        baseLayers[basemapType].addTo(map);

        // Re-add the markers based on current mode
        if (clusterMode) {
            enableClustering();
        } else {
            map.addLayer(customMarkers);
        }

        // Re-add route if exists
        if (routeLine) {
            routeLine.addTo(map);
        }

        // Re-add current location marker if exists
        if (currentLocationMarker) {
            currentLocationMarker.addTo(map);
        }

        // Re-add custom location markers if exist
        customLocationMarkers.forEach(function(marker) {
            marker.addTo(map);
        });

        // Re-add drawn items for measurements
        if (drawnItems) {
            map.addLayer(drawnItems);
        }

        // Re-add road network if visible
        if (roadNetworkVisible && roadNetworkLayer) {
            roadNetworkLayer.addTo(map);
        }
    });

    // Search functionality
    $('#site-search').on('input', function() {
        var query = $(this).val().toLowerCase();
        var resultsContainer = $('#search-results');

        if (query.length < 2) {
            resultsContainer.hide();
            return;
        }

        var results = touristSites.filter(function(site) {
            return site.name.toLowerCase().includes(query);
        });

        resultsContainer.empty();

        if (results.length > 0) {
            results.forEach(function(site) {
                var resultItem = $('<div class="search-result-item">' + site.name + '</div>');
                resultItem.click(function() {
                    if (routingMode) {
                        addToRoute(site.scene);
                    } else {
                        goToScene(site.scene);
                    }
                    $('#site-search').val('');
                    resultsContainer.hide();
                });
                resultsContainer.append(resultItem);
            });
            resultsContainer.show();
        } else {
            resultsContainer.hide();
        }
    });

    // Hide search results when clicking outside
    $(document).click(function(e) {
        if (!$(e.target).closest('.search-container').length) {
            $('#search-results').hide();
        }
    });

    // Scene navigation buttons
    $('#next-scene').click(function() {
        if (currentSceneIndex < sceneOrder.length - 1) {
            currentSceneIndex++;
            goToScene(sceneOrder[currentSceneIndex]);
        }
    });

    $('#prev-scene').click(function() {
        if (currentSceneIndex > 0) {
            currentSceneIndex--;
            goToScene(sceneOrder[currentSceneIndex]);
        }
    });

    // Start tour button
    $('#start-tour').click(function() {
        currentSceneIndex = 1; // Start with first tourist site
        goToScene(sceneOrder[currentSceneIndex]);
    });

    // Restart tour button
    $('#restart-tour').click(function() {
        currentSceneIndex = 0;
        goToScene(sceneOrder[currentSceneIndex]);

        // Re-enable clustering when returning to overview
        if (!clusterMode) {
            clusterMode = true;
            $('.cluster-btn').removeClass('active');
            $('#cluster-on').addClass('active');
            enableClustering();
        }

        // Clear any active route
        clearRoute();
    });

    // Mobile menu toggle
    $('#mobile-menu-toggle').click(function() {
        $('.storymap-story').toggleClass('active');
    });

    // Add legend
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <h4>Tourist Sites</h4>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>Historical Sites</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f39c12;"></div>
                <span>Cultural Centers</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span>Beach Resorts</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2ecc71;"></div>
                <span>Natural Attractions</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4285F4;"></div>
                <span>Current Location</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9b59b6;"></div>
                <span>Custom Location</span>
            </div>
        `;
        return div;
    };
    legend.addTo(map);

    // Toggle site list on scene indicator click
    $('#current-scene').click(function() {
        $('#site-list').toggle();
    });

    // Initialize with the first scene
    goToScene(sceneOrder[0]);

    // Keyboard navigation
    $(document).keydown(function(e) {
        if (e.keyCode == 37) { // Left arrow
            $('#prev-scene').click();
        } else if (e.keyCode == 39) { // Right arrow
            $('#next-scene').click();
        } else if (e.keyCode == 27) { // Escape key
            $('#search-results').hide();
            $('#site-list').hide();
            $('#custom-location-modal').hide();
            // Also exit routing mode and map click mode
            if (routingMode) {
                routingMode = false;
                $('#start-route').removeClass('active');
                updateRoutingStatus('Route planning stopped', 'warning');
            }
            if (mapClickMode) {
                toggleMapClickMode();
            }
            // Exit measurement mode
            if (measurementMode) {
                clearMeasurements();
            }
        }

        // Measurement shortcuts
        if (e.keyCode == 77 && e.ctrlKey) { // Ctrl+M for measurement
            $('#measure-distance').click();
            e.preventDefault();
        }
        if (e.keyCode == 65 && e.ctrlKey) { // Ctrl+A for area measurement
            $('#measure-area').click();
            e.preventDefault();
        }
        if (e.keyCode == 67 && e.ctrlKey) { // Ctrl+C to clear measurements
            $('#clear-measurements').click();
            e.preventDefault();
        }
    });

    // Initialize lightbox
    lightbox.option({
        'resizeDuration': 200,
        'wrapAround': true,
        'imageFadeDuration': 300,
        'positionFromTop': 50
    });

    // Custom location modal handlers
    $('#cancel-custom-location').click(function() {
        $('#custom-location-modal').hide();
    });

    $('#confirm-custom-location').click(function() {
        var lat = parseFloat($('#custom-lat').val());
        var lng = parseFloat($('#custom-lng').val());
        var name = $('#custom-name').val() || 'Custom Location';

        if (isNaN(lat) || isNaN(lng)) {
            alert('Please enter valid latitude and longitude values');
            return;
        }

        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            alert('Please enter valid coordinates (Latitude: -90 to 90, Longitude: -180 to 180)');
            return;
        }

        addLocationToRoute(lat, lng, name, false);
        $('#custom-location-modal').hide();

        // Clear the form
        $('#custom-lat').val('');
        $('#custom-lng').val('');
        $('#custom-name').val('');

        // Ensure routing mode is enabled
        if (!routingMode) {
            toggleRoutingMode();
        }
    });

    // Clear route from sidebar
    $('#clear-route-sidebar').click(function() {
        clearRoute();
    });

    // Unit toggle
    $('#use-km').click(function() {
        $('.unit-toggle .btn').removeClass('active');
        $(this).addClass('active');
        useMetric = true;
        // Refresh the route summary display if we have a route
        if (routeWaypoints.length >= 2) {
            calculateRoute(); // Recalculate with new units
        }
    });

    $('#use-miles').click(function() {
        $('.unit-toggle .btn').removeClass('active');
        $(this).addClass('active');
        useMetric = false;
        // Refresh the route summary display if we have a route
        if (routeWaypoints.length >= 2) {
            calculateRoute(); // Recalculate with new units
        }
    });

    // Toggle auto-rotation
    $('#auto-rotate-on').click(function() {
        autoRotateEnabled = true;
        $('.rotation-btn').removeClass('active');
        $(this).addClass('active');

        if (currentSceneIndex > 0 && currentSceneIndex < sceneOrder.length - 1) {
            var scene = scenes[sceneOrder[currentSceneIndex]];
            startAutoRotation([scene.lat, scene.lng], scene.zoom);
        }
    });

    $('#auto-rotate-off').click(function() {
        autoRotateEnabled = false;
        $('.rotation-btn').removeClass('active');
        $(this).addClass('active');
        stopAutoRotation();
    });

    // Toggle clustering
    $('#cluster-on').click(function() {
        clusterMode = true;
        $('.cluster-btn').removeClass('active');
        $(this).addClass('active');
        enableClustering();
    });

    $('#cluster-off').click(function() {
        clusterMode = false;
        $('.cluster-btn').removeClass('active');
        $(this).addClass('active');
        disableClustering();
    });

    // Toggle controls visibility
    function toggleControls() {
        controlsVisible = !controlsVisible;

        if (controlsVisible) {
            // Show all controls
            $('.map-controls').show();
            $('.rotation-controls').show();
            $('.cluster-controls').show();
            $('.combined-routing-controls').show();
            $('.measurement-controls').show();
            $('#toggle-icon').removeClass('fa-chevron-left').addClass('fa-chevron-right');
            $('#toggle-controls').attr('title', 'Hide Controls');
        } else {
            // Hide all controls
            $('.map-controls').hide();
            $('.rotation-controls').hide();
            $('.cluster-controls').hide();
            $('.combined-routing-controls').hide();
            $('.measurement-controls').hide();
            $('#toggle-icon').removeClass('fa-chevron-right').addClass('fa-chevron-left');
            $('#toggle-controls').attr('title', 'Show Controls');
        }
    }

    $('#toggle-controls').click(function() {
        toggleControls();
    });

    // Utility functions
    function getCardinalDirection(bearing) {
        var directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        var index = Math.round(bearing / 22.5) % 16;
        return directions[index];
    }

    // Helper function to get bearing direction between two points
    function getBearingDirection(point1, point2) {
        const bearing = calculateBearing(point1[0], point1[1], point2[0], point2[1]);
        return getCardinalDirection(bearing);
    }

    // Improved direction icon function
    function getDirectionIcon(type) {
        var icons = {
            'Head': '🚦',
            'Continue': '➡️',
            'TurnLeft': '⬅️',
            'TurnRight': '➡️',
            'SharpLeft': '↰',
            'SharpRight': '↱',
            'SlightLeft': '↖️',
            'SlightRight': '↗️',
            'Merge': '🔀',
            'Roundabout': '🔃',
            'Start': '📍',
            'Destination': '🏁',
            'Fork': '🔀',
            'UTurn': '↪️'
        };

        return icons[type] || '📍';
    }

    // Improved road direction function
    function getRoadDirection(bearing) {
        if (bearing >= 337.5 || bearing < 22.5) {
            return "North";
        } else if (bearing >= 22.5 && bearing < 67.5) {
            return "Northeast";
        } else if (bearing >= 67.5 && bearing < 112.5) {
            return "East";
        } else if (bearing >= 112.5 && bearing < 157.5) {
            return "Southeast";
        } else if (bearing >= 157.5 && bearing < 202.5) {
            return "South";
        } else if (bearing >= 202.5 && bearing < 247.5) {
            return "Southwest";
        } else if (bearing >= 247.5 && bearing < 292.5) {
            return "West";
        } else {
            return "Northwest";
        }
    }

    function calculateBearing(lat1, lng1, lat2, lng2) {
        var startLat = deg2rad(lat1);
        var startLng = deg2rad(lng1);
        var endLat = deg2rad(lat2);
        var endLng = deg2rad(lng2);

        var dLng = endLng - startLng;
        var y = Math.sin(dLng) * Math.cos(endLat);
        var x = Math.cos(startLat) * Math.sin(endLat) - Math.sin(startLat) * Math.cos(endLat) * Math.cos(dLng);
        var bearing = Math.atan2(y, x);

        // Convert to degrees and normalize
        bearing = rad2deg(bearing);
        bearing = (bearing + 360) % 360;

        return bearing;
    }

    function rad2deg(rad) {
        return rad * (180 / Math.PI);
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var d = R * c; // Distance in km
        return d;
    }

</script>
</body>
</html>